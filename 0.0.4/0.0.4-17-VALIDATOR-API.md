# VAPI — Validator API (REST/CLI IO)

## VAPI.0 Scope

Defines a stable, implementation-agnostic interface for validating, rendering, digesting, and diff-validating CAH artifacts. Conforms to prior contracts: V1 (validator), RCA, CTM/TOS, IVS, ADS, NDM, PEG.

## VAPI.1 Transport

* **REST:** HTTPS, JSON bodies, UTF-8, `Content-Type: application/json`.
* **CLI:** POSIX-compatible executable with subcommands; JSON I/O via STDIN/STDOUT; exit codes per CI §CI.1.

## VAPI.2 Auth & Limits (REST)

* Auth scheme: Bearer token (opaque).
* Limits headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`.
* Payload limits: minimum 10 MiB; rejection emits JSON error with `status=413`.

## VAPI.3 Core Types (shared)

* `DiagramText`: string (UTF-8), may include frames.
* `SerializedJSON`: object (T5).
* `NormalizerCatalog`: object (B.1).
* `ValidationReport`: object (V1.5).
* `TestOutcome`: object (TOS).
* `IncrementalTicket`: object (IVS.3).
* `FeaturesManifest`: object (FEA).
* `PrivacyPolicy`: object (PVP.2).

---

## VAPI.4 REST Endpoints

### 1) `POST /v1/validate`

* **Purpose:** Full validation run (P-LEX → P-PREC) with optional serialization and features.
* **Request body:**

  * `diagram_text: DiagramText` (optional if `serialized_json` present)
  * `serialized_json: SerializedJSON|null` (optional)
  * `normalizer_catalog: NormalizerCatalog` (required)
  * `features: FeaturesManifest` (optional; default: none)
  * `privacy_policy: PrivacyPolicy` (optional; default: PG-0)
  * `options: { strict:boolean, coerce_older_versions:boolean, emit_warnings:boolean }`
* **Response body:**

  * `validation_report: ValidationReport`
  * `diagram_digest: hex-64`
  * `artifacts?: { serialized?: object, ast?: object, segments?: object }`
* **HTTP status:** `200` on success; `4xx/5xx` with JSON error otherwise.

### 2) `POST /v1/render`

* **Purpose:** RCA rendering; returns canonical glyph stream and digest.
* **Request body:** one of `diagram_text` | `serialized_json`; `options: { emit_frame?: boolean }`
* **Response body:** `{ glyphs:string, digest:hex-64 }`

### 3) `POST /v1/digest`

* **Purpose:** Compute canonical digest without returning glyphs.
* **Request body:** same source fields as `/v1/render`.
* **Response body:** `{ digest:hex-64 }`

### 4) `POST /v1/incremental/validate`

* **Purpose:** Incremental re-validation per IVS.
* **Request body:**

  * `ticket: IncrementalTicket`
  * `diagram_text: DiagramText` (partial or full)
  * `normalizer_catalog: NormalizerCatalog`
* **Response body:**

  * `validation_report: ValidationReport`
  * `draft: boolean`
  * `affected_rows: int[]`

### 5) `POST /v1/ctm/run`

* **Purpose:** Execute a CTM suite; emit TOS.
* **Request body:**

  * `manifest: CTM (schema)`
  * `normalizer_catalog: NormalizerCatalog`
  * `rng?: { seed:int }`
* **Response body:** `TestOutcome`

### 6) `POST /v1/provenance/sign`

* **Purpose:** Apply optional provenance signature (PVP.3) to a commit or serialized structure.
* **Request body:** `{ target: object, key_ref:string }`
* **Response body:** `{ signed: object }`

### 7) `POST /v1/adapt`

* **Purpose:** Apply an adapter (ADP) from legacy versions to 0.0.3.
* **Request body:** `{ adapter: ADP schema, diagram_text?:string, serialized_json?:object }`
* **Response body:** `{ diagram_text?:string, serialized_json?:object, notes?:string[] }`

### 8) `GET /v1/healthz`

* **Purpose:** Liveness.
* **Response body:** `{ status:"ok", version:"0.0.3" }`

### 9) `GET /v1/version`

* **Purpose:** Report supported spec and feature gates.
* **Response body:** `{ spec_version:"0.0.3", features: FeaturesManifest["capabilities"] }`

### Error envelope (REST)

* **Shape:** `{ error:{ code:string, message:string, detail?:object } }`
* **Mapping:** Must map to E-* codes where applicable; transport codes remain HTTP-native.

---

## VAPI.5 CLI Interface

### Commands

* `cah validate`
  Flags: `--diagram -`, `--json -`, `--catalog file`, `--features file?`, `--privacy file?`, `--strict`, `--no-warn`, `--coerce-older`, `--emit-artifacts ast,segments,serialized`, `--out file.json`
* `cah render`
  Flags: `--diagram -|file`, `--json file`, `--emit-frame`, `--out file.txt`
* `cah digest`
  Flags: `--diagram -|file`, `--json file`
* `cah incremental`
  Flags: `--ticket file`, `--diagram -|file`, `--catalog file`, `--out file.json`
* `cah ctm-run`
  Flags: `--manifest file`, `--catalog file`, `--seed N`, `--out file.json`
* `cah adapt`
  Flags: `--adapter file`, `--diagram -|file`, `--json file`, `--out file.{json,txt}`
* `cah version`
  No flags; emits capabilities.

### Exit codes

* `0` success, `1` fail/error in validation/tests, `2` invalid input/schema, `3` bundle verification error, `4` environment unsupported.

---

## VAPI.6 Determinism & Caching

* Deterministic outputs for identical inputs (see V1.2).
* REST servers MAY cache digests keyed by `SHA-256` of normalized inputs; must not leak data across tenants.

---

## VAPI.7 Security

* No code execution from inputs.
* Enforce size/time limits with explicit errors (`E-SYN-101` resource limit).
* TLS required; reject plaintext.

---
