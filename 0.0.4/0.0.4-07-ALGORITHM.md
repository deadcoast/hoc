# RCA — Re-Rendering Canonicalization Algorithm (Deterministic)

## RCA.0 Objective

Produce a **canonical ASCII glyph stream** from either:

* Parsed structures (AST + Segment Map), or
* Serialized JSON (T5), or
* Diagram text re-normalized,
  such that `diagram_digest` (T5.4) is stable and round-trips (RND.3).

## RCA.1 Inputs

* `AST` (A-ST) and `S-MAP` (S-MAP), **or** `serialized_json` (T5), **or** `diagram_text` (raw).
* `options`:

  * `emit_frame: boolean` (default `true`)
  * `frame_chars: set` (default box drawing)
  * `pad_segments: boolean` (default `false`)

## RCA.2 Outputs

* `canonical_glyph_stream: string` (UTF-8, `\n` line endings)
* `digest: hex-64` (SHA-256 over RCA.8)

## RCA.3 Precedence of Sources

1. If `AST`/`S-MAP` present and valid → use them.
2. Else if `serialized_json` present → reconstruct `AST`/`S-MAP` then proceed.
3. Else if `diagram_text` present → parse to `AST`/`S-MAP` then proceed.
4. Else → hard failure (`E-SYN-101`).

## RCA.4 Row Construction

For each `row` in ascending order:

1. **Segment emission order:** `E_SC`, `│`, `M_SC`, `│`, `P_SC`.
2. **Segment content ordering (within each segment):**

   * **Nodes** (if any) rendered at their recorded `offset` (A-ST.10).
   * **Lanes** (center rows only, A-ST.11) rendered as `(emo: … :phl)` with variable sets lexicographically ordered by identifier (T5.2) and single spaces after commas (T9.2 policy applies during hashing).
   * **Flow expressions**: tokens emitted in **`order`** (A-ST.7) with operator/term lexemes from `norm`.
   * **DESC fences**: placed at their recorded coordinates (A-ST.14).
3. **No interleaving**: Token classes must not overlap offsets. Conflicts → `E-LYT-201`.

## RCA.5 Whitespace Canonicalization (per row)

* Inside segments, collapse multiple spaces to **single space**, **except**:

  * **Triple-v** spacing: exactly two spaces between the three `v` markers (T9.2).
  * **Five-v** fence: contiguous `vvvvv` (no spaces).
* Strip trailing spaces.
* Preserve leading spaces **only** if they precede a triple-v sequence; otherwise strip.

## RCA.6 Borders/Frames

* If `emit_frame=true`, surround semantic rows with single-line frame using `frame_chars`.
* Frame is **non-semantic** and excluded from internal offsets.
* Frame glyphs **must not** interleave inside segments (T9.3).

## RCA.7 Column Separators

* Emit exactly **one** `│` between segments.
* `│` positions are authoritative column boundaries; no token may straddle them.

## RCA.8 Digest Calculation

* Before hashing, **strip** all frame lines and all frame glyphs from rows (T5.3).
* Ensure line endings are `\n`.
* Apply whitespace rules from RCA.5.
* Compute SHA-256; encode as lower-case hex (64 chars).

## RCA.9 Determinism Invariants

* Given identical `AST`/`S-MAP`, RCA **must** regenerate a bit-identical glyph stream.
* Variable ordering is stable: identifiers sorted lexicographically; arrays in **creation order** (T5.2) elsewhere.

## RCA.10 Error Conditions (render path)

* Overlapping tokens at same offset → `E-LYT-201`.
* Missing mandatory nodes (CHO/ACT/DEC/ABT/DEF) → `E-SYN-104`.
* Illegal operator in DEF block → `E-DEF-703`.
* TAB encountered in any content → `E-SYN-103`.

## RCA.11 Performance Envelope (non-normative but required minimums)

* Implementations **SHOULD** handle:

  * up to **10k rows**,
  * up to **1k spans** per document,
  * O(N) time in number of tokens,
  * O(N) memory with indices (IDX) constructed once.

---

## MCC — Minimal Compliance Checklist (0.0.3)

**Purpose:** Establish the smallest set of requirements an implementation MUST satisfy to claim CAH 0.0.3 compliance.

## MCC.1 Parsing & Tokenization

* [ ] Enforce **no TABs**; emit `E-SYN-103`.
* [ ] Recognize all **reserved symbols/keywords** (T10).
* [ ] Build **AST** nodes with correct `span` coordinates (A-ST.2).
* [ ] Construct **S-MAP** grid with exactly three segments per row (S-MAP.2).

## MCC.2 Ports & Fences

* [ ] Detect **P_E1, P_P1, P_M1, P_A1** using exact glyph patterns (T2.1).
* [ ] Record **TRIPLE** and **FIVE** descent fences with locations (A-ST.14).
* [ ] Enforce **no operator reordering** across fences (`E-BARRIER-601`).

## MCC.3 Operators & Routes

* [ ] Validate operators with **legality schema** (A.2) per `(column, port)`.
* [ ] Require `OPEN_*` for any **lane→C-SP** crossing (`E-ROUTE-401`).
* [ ] Require `CLOSE_*` before **C-SP→lane** or **ABT→DEF** egress (`E-ROUTE-402`).
* [ ] Forbid lateral **BRANCH** without port (`E-ROUTE-404`).

## MCC.4 Spans

* [ ] Maintain **stack discipline** (per side) for open/close pairs (`E-SPAN-303`).
* [ ] Forbid **empty spans** (`E-SPAN-304`).
* [ ] Prevent payload attachment after closure (`E-SPAN-305`).

## MCC.5 Variables & Side Typing

* [ ] Accept only `ev*` on **E_SC**, `pv*` on **P_SC**; else `E-SPAN-307`.
* [ ] Record variables under `payloads` with `{scale, conf, dir}` fields (T5.4).

## MCC.6 Normalization & Parity

* [ ] Resolve each variable to **exactly one** normalizer (B.2 invariants).
* [ ] Enforce unit match (`E-NORM-A03`) and policy bounds (`E-NORM-A04`).
* [ ] Compute side aggregates; apply thresholds `θ_emo=1.00`, `θ_phl=1.00` and ratio `ρ=0.67` (T3.7).
* [ ] Emit `E-PARITY-*` on failure; block DEF.

## MCC.7 ABT & DEF Contracts

* [ ] ABT admits only **parity-qualified** payload with **open** ingress spans.
* [ ] All spans **closed** prior to any DEF ingress (`E-DEF-701/702` if violated).
* [ ] Forbid operators inside DEF block (`E-DEF-703`).
* [ ] Enforce **single atomic commit** per evaluation tick (`E-DEF-704`).

## MCC.8 Serialization & Digest

* [ ] Produce **canonical JSON** (T5.1–T5.2) with stable ordering.
* [ ] Generate `diagram_digest` using **RCA** (RCA.8) rules.
* [ ] If `serialized_json` is present, perform **diagram supremacy** check (T8.2).

## MCC.9 Validation Phases & Diagnostics

* [ ] Execute the **phase graph** in V1.3 order.
* [ ] Stop on first **ERROR** per phase; continue to report all errors in later phases only if `options.strict=false`.
* [ ] Emit diagnostics with **diagram_loc and/or json_ptr** (V1.4, V3).

## MCC.10 Round-Trip Guarantees

* [ ] Ensure `digest(render(parse(diagram))) == digest(diagram)` (RND.3).
* [ ] Ensure `digest(render(structure)) == diagram_digest(structure)`.

## MCC.11 Conformance Artifacts

* [ ] Provide `validation_report` (V1.5) with `ast`, `segments`, `spans`, `nodes`, and `serialized` artifacts.
* [ ] Log **all WARNs** (Version/Precedence/Layout) without blocking commit.

## MCC.12 Security & Robustness (non-functional MUSTs)

* [ ] Reject documents exceeding declared limits **without crash**; emit `E-SYN-101` (reason: resource limit).
* [ ] Validate Unicode to **UTF-8 NFC**; reject non-UTF-8 input (`E-SYN-101`).
* [ ] No code execution from inputs; all evaluation is purely structural.

---
