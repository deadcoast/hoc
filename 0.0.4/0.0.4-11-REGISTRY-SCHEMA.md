# IRS — Issuer Registry Schema (Trusted Issuers + Keys)

## IRS.1 Purpose

Define a canonical, signed registry of trusted badge issuers, their public keys, policies, and revocation endpoints to enable offline/online verification of CAH compliance badges.

## IRS.2 Trust Model

- Registry is signed by a **Root Authority** (RA).
- Verifiers MUST validate the registry signature before using its contents.
- Issuer entries may include **multiple active keys** and **historical/expired keys** for verification of older badges.

## IRS.3 Top-Level JSON Schema

```json
{
  "$id": "cah-0.0.4-issuer-registry.schema.json",
  "title": "CAH Issuer Registry",
  "type": "object",
  "properties": {
    "series": { "const": "CAH" },
    "version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
    "registry_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{3,64}$" },
    "issued_at": { "type": "string", "format": "date-time" },
    "expires_at": { "type": "string", "format": "date-time" },
    "policies": {
      "type": "object",
      "properties": {
        "required_algorithms": {
          "type": "array",
          "items": { "enum": ["ed25519","ecdsa-p256","rsa-pss-sha256"] },
          "uniqueItems": true
        },
        "min_key_bits": { "type": "integer", "minimum": 256 },
        "https_required": { "type": "boolean", "const": true },
        "max_clock_skew_seconds": { "type": "integer", "minimum": 0, "default": 300 }
      },
      "additionalProperties": false
    },
    "issuers": {
      "type": "array",
      "items": { "$ref": "#/$defs/issuer" },
      "minItems": 1
    },
    "signatures": {
      "type": "array",
      "items": { "$ref": "#/$defs/signature" },
      "minItems": 1
    }
  },
  "required": ["series","version","registry_id","issued_at","issuers","signatures"],
  "additionalProperties": false,
  "$defs": {
    "issuer": {
      "type": "object",
      "properties": {
        "issuer_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{3,64}$" },
        "name": { "type": "string" },
        "status": { "enum": ["active","suspended","retired"] },
        "contact": {
          "type": "object",
          "properties": {
            "website": { "type": "string", "format": "uri" },
            "email": { "type": "string" }
          },
          "additionalProperties": false
        },
        "keys": {
          "type": "array",
          "items": { "$ref": "#/$defs/key" },
          "minItems": 1
        },
        "endpoints": {
          "type": "object",
          "properties": {
            "badge_status": { "type": "string", "format": "uri" },
            "jwks": { "type": "string", "format": "uri" },
            "crl": { "type": "string", "format": "uri" }
          },
          "additionalProperties": false
        },
        "policies": {
          "type": "object",
          "properties": {
            "badge_expiry_max_days": { "type": "integer", "minimum": 1 },
            "key_rotation_days": { "type": "integer", "minimum": 7 },
            "revocation_latency_sla_minutes": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "required": ["issuer_id","status","keys"],
      "additionalProperties": false
    },
    "key": {
      "type": "object",
      "properties": {
        "key_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{3,128}$" },
        "alg": { "enum": ["ed25519","ecdsa-p256","rsa-pss-sha256"] },
        "format": { "enum": ["jwk","pem"] },
        "public": { "type": "string" },
        "created_at": { "type": "string", "format": "date-time" },
        "expires_at": { "type": "string", "format": "date-time" },
        "status": { "enum": ["active","expired","revoked"] },
        "revocation_reason": { "type": "string" }
      },
      "required": ["key_id","alg","format","public","status"],
      "additionalProperties": false
    },
    "signature": {
      "type": "object",
      "properties": {
        "alg": { "enum": ["ed25519","ecdsa-p256","rsa-pss-sha256"] },
        "key_id": { "type": "string" },
        "sig": { "type": "string", "pattern": "^[A-Za-z0-9+/=]+$" },
        "signer": { "type": "string" },
        "scope": { "const": "registry" }
      },
      "required": ["alg","key_id","sig","scope"],
      "additionalProperties": false
    }
  }
}
```

Signatures MUST be base64-encoded and accompanied by a `signer` identifier that resolves to a valid issuing authority.

## IRS.4 Semantics

- `expires_at` of the registry MUST be in the future for the registry to be valid; otherwise treat as stale.
- Issuer `status="retired"`: badges remain verifiable if the validating key was active at the badge `issued_at`, and not revoked at or after that time.
- Keys with `status="revoked"` MUST NOT be accepted past their revocation timestamp.

## IRS.5 Distribution & Caching

- Transport MUST be HTTPS.
- Clients SHOULD honor `Cache-Control: max-age` but MUST re-validate if `expires_at` is passed or a badge verification requires a fresher registry.

---

## BVP — Badge Verification Protocol (Transport, Caching, Freshness)

## BVP.1 Goal

Define the end-to-end verification procedure for a CAH compliance badge, including trust bootstrap, signature verification, revocation checks, registry handling, and freshness requirements.

## BVP.2 Inputs

- `badge_json`: candidate badge (CBS-compliant).
- `issuer_registry`: trusted IRS document (validated).
- Optional: `reference_bundle_manifest` (RBM) and `test_outcome` (TOS).

## BVP.3 Output

- `verdict ∈ {VALID, INVALID, STALE, REVOKED, SUSPENDED}`
- `reasons[]`: machine-readable strings referencing error categories.
- `details`: structured record of checks performed (see BVP.7).

## BVP.4 Transport Requirements

- All network retrievals (registry, JWKS, CRL, badge status) MUST use HTTPS with valid certificates and hostname verification.
- Redirects MUST preserve scheme HTTPS→HTTPS; downgrade is forbidden.

## BVP.5 Verification Steps (normative sequence)

1. **Schema Validation**

   - Validate `badge_json` against **CBS**; on failure: `INVALID/CODE:CBS_SCHEMA`.
2. **Time Window**

   - Check `issued_at ≤ now + skew` and, if present, `expires_at ≥ now − skew`.
   - If expired: `STALE/CODE:BADGE_EXPIRED`.
3. **Issuer Resolution**

   - Locate `badge_json.issuer.id` in **IRS**. If missing or `status="retired"` without valid time overlap: `INVALID/CODE:ISSUER_UNKNOWN`.
4. **Key Selection**

   - Resolve `badge.signature.key_id` to an issuer key active at `issued_at`. If none: `INVALID/CODE:KEY_NOT_FOUND`.
5. **Signature Verification**

   - Verify `badge.signature` over the canonical JSON (excluding the `signature` object). If invalid: `INVALID/CODE:SIG_INVALID`.
6. **Revocation Checks**

   - If issuer `endpoints.crl` present: fetch (cache-aware) and confirm `badge` or `key_id` not listed.
   - If `revocation.status` present in badge and equals `"revoked"`: `REVOKED`.
   - If issuer status `"suspended"` or badge `revocation.status="suspended"`: `SUSPENDED`.
7. **Evidence Cross-Checks (recommended, normative when present)**

   - If `evidence.tos_digest` is present: fetch/verify **TOS**; confirm `run_id` and digest match; ensure `summary.failed==0` and `summary.errors==0` for level C.
   - If `evidence.rbm_bundle_digest` present: fetch/verify **RBM**; check `bundle_digest` and presence of normative files.
   - If mismatches: `INVALID/CODE:EVIDENCE_MISMATCH`.
8. **RPP Consistency**

   - Validate embedded **RPP** against schema and that `conformance_level` ↔ `badge.level` mapping holds; mismatch: `INVALID/CODE:RPP_INCONSISTENT`.
9. **Freshness**

   - Ensure **IRS** `expires_at` not passed. If passed but key/signature otherwise valid: `STALE/CODE:REGISTRY_EXPIRED`.
10. **Final Verdict**

- If all checks pass and no suspension/revocation: `VALID`.

## BVP.6 Caching & Freshness Policy

- **Registry**: cache ≤ `min(IRS.expires_at, 7 days)`; MUST re-fetch if expired.
- **CRL/JWKS**: cache per `Cache-Control` but not longer than 24h by default; immediate re-fetch when signature verification fails unexpectedly.
- **Status endpoint**: responses ≤ 5 minutes freshness unless endpoint declares longer with signatures.

## BVP.7 Verification Details Structure

```json
{
  "series": "CAH",
  "spec_version": "0.0.4",
  "badge_level": "CAH-0.0.4-C",
  "verdict": "VALID",
  "checks": [
    { "name": "SCHEMA", "status": "PASS" },
    { "name": "TIME_WINDOW", "status": "PASS" },
    { "name": "ISSUER_RESOLUTION", "status": "PASS" },
    { "name": "KEY_SELECTION", "status": "PASS" },
    { "name": "SIGNATURE", "status": "PASS" },
    { "name": "REVOCATION", "status": "PASS" },
    { "name": "EVIDENCE", "status": "PASS" },
    { "name": "RPP_CONSISTENCY", "status": "PASS" },
    { "name": "FRESHNESS", "status": "PASS" }
  ],
  "inputs": {
    "issuer_id": "…",
    "key_id": "…",
    "registry_id": "…"
  },
  "caching": {
    "registry_cached_at": "…",
    "registry_expires_at": "…",
    "crl_cached_at": "…"
  }
}
```

## BVP.8 Error Categories (machine-readable reasons)

- `CBS_SCHEMA`, `BADGE_EXPIRED`, `ISSUER_UNKNOWN`, `KEY_NOT_FOUND`, `SIG_INVALID`,
  `REGISTRY_EXPIRED`, `CRL_STALE`, `REVOKED`, `SUSPENDED`, `EVIDENCE_MISMATCH`, `RPP_INCONSISTENT`, `NETWORK_ERROR`, `TLS_ERROR`.

## BVP.9 Security Requirements

- **No unsigned registries**: IRS must contain at least one valid signature from RA.
- **No HTTP**: all endpoints HTTPS only.
- **Clock skew**: verifiers MUST apply `policies.max_clock_skew_seconds`.
- **Key pinning**: implementations SHOULD pin issuer `key_id` after first successful verification for short-term resilience.

## BVP.10 Privacy & Data Minimization

- Do not send badge contents to issuer except for status queries that accept **digest-only** payloads.
- Store only hashes and minimal metadata required for audit.

---
