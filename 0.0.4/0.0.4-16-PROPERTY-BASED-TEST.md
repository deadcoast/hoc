# PTS — Property-Based Test Specification (Generator & Oracle)

## PTS.0 Scope

Define machine-runnable **property tests** for validators/renders, including generators, shrinking, invariants, and expected oracles. Integrates with CTM/TOS; extends RCA, NDM, PEG, ADS, IVS.

## PTS.1 Concepts

- **Generator**: produces random-but-valid structures/diagrams within constraints.
- **Oracle**: property predicate(s) over outputs (validator reports, digests).
- **Shrink**: deterministic strategy to minimize failing cases.
- **Seed**: 64-bit integer controlling RNG determinism.

## PTS.2 Manifest Schema

```json
{
  "$id": "cah-0.0.4-property-tests.schema.json",
  "title": "CAH Property Tests",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "suite_id": { "type": "string", "pattern": "^[a-z0-9._-]{3,64}$" },
    "rng": {
      "type": "object",
      "properties": {
        "seed": { "type": "integer", "minimum": 0 },
        "iterations": { "type": "integer", "minimum": 1 },
        "shrink_limit": { "type": "integer", "minimum": 0 }
      },
      "required": ["iterations"],
      "additionalProperties": false
    },
    "generators": {
      "type": "array",
      "items": { "$ref": "#/$defs/generator" },
      "minItems": 1
    },
    "properties": {
      "type": "array",
      "items": { "$ref": "#/$defs/property" },
      "minItems": 1
    },
    "oracles": {
      "type": "array",
      "items": { "$ref": "#/$defs/oracle" },
      "minItems": 1
    }
  },
  "required": ["version","suite_id","rng","generators","properties","oracles"],
  "additionalProperties": false,
  "$defs": {
    "generator": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9._-]{3,64}$" },
        "domain": { "enum": ["diagram","serialized_json","ast","segment_map"] },
        "constraints": { "type": "object", "additionalProperties": true },
        "weights": { "type": "object", "additionalProperties": { "type": "number" } },
        "enable_streaming": { "type": "boolean", "default": false }
      },
      "required": ["id","domain"],
      "additionalProperties": false
    },
    "property": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9._-]{3,64}$" },
        "description": { "type": "string" },
        "applies_to": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "oracle_ids": { "type": "array", "items": { "type": "string" }, "minItems": 1 }
      },
      "required": ["id","applies_to","oracle_ids"],
      "additionalProperties": false
    },
    "oracle": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9._-]{3,64}$" },
        "predicate": { "enum": [
          "RCA_ROUNDTRIP_EQ",
          "VALIDATOR_DETERMINISM",
          "NO_TAB_GLYPHS",
          "PORT_DETECTION_TOTALITY",
          "SPAN_STACK_DISCIPLINE",
          "NO_CROSS_FENCE_REORDER",
          "DEF_ATOMICITY",
          "NUMERIC_CANONICAL_JSON",
          "PARITY_ASSOCIATIVITY_ORDERED",
          "DIAGRAM_SUPREMACY",
          "INCREMENTAL_EQUIVALENCE"
        ]},
        "params": { "type": "object", "additionalProperties": true }
      },
      "required": ["id","predicate"],
      "additionalProperties": false
    }
  }
}
```

In this schema:

- `applies_to` enumerates generator identifiers that feed a property
- `phase_hint` helps implementers surface lint context (e.g., `P-LAYOUT`)
- `selector` adapter rules use strings to address fields within serialized JSON or diagram tokens

## PTS.3 Runner Semantics

- Each generated case is validated end-to-end; failing cases must be **shrunk** by replaying with reduced complexity while preserving failure.
- Determinism: same `seed` and manifest produce identical sequences and outcomes.
- Outcomes exported via **TOS** with `category="DIGEST"|"PREC"|"PERF"|…` and `intent="POSITIVE"` unless a property explicitly expects failure.

---

## LNC — Lint Catalog (Non-Blocking Diagnostics)

## LNC.0 Scope

Define **lint** diagnostics (`L-` codes) for style, readability, potential ambiguity, and performance hints. Lints are optional, non-blocking, and separate from `E-*` errors.

## LNC.1 Code Format

- `L-<CLASS>-<NNN>` where `<CLASS> ∈ {STYLE,READ,AMBIG,PERF,PRIV}` and `<NNN>` is a zero-padded integer.

## LNC.2 Lint Record Schema

```json
{
  "$id": "cah-0.0.4-lint-catalog.schema.json",
  "title": "CAH Lint Catalog",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "lints": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "code": { "type": "string", "pattern": "^L-(STYLE|READ|AMBIG|PERF|PRIV)-[0-9]{3}$" },
          "message": { "type": "string" },
          "rationale": { "type": "string" },
          "phase_hint": { "type": "string" },
          "autofix": { "type": "boolean", "default": false },
          "severity": { "enum": ["LOW","MEDIUM","HIGH"], "default": "LOW" }
        },
        "required": ["code","message"],
        "additionalProperties": false
      }
    }
  },
  "required": ["version","lints"],
  "additionalProperties": false
}
```

## LNC.3 Emission Rules

- Lints are produced in a separate `lints[]` array in `validation_report`.
- Lints MUST NOT influence `passed`.
- Implementations MAY provide `autofix` suggestions; any modifications must not alter semantics or diagram digest (if applied, re-run RCA to confirm equality).

---

## ADP — Adapters 0.0.1 / 0.0.2 → 0.0.4 (Lossiness & Remaps)

## ADP.0 Scope

Define machine-readable adapter specifications to transform legacy CAH diagrams/structures (0.0.1, 0.0.2) into 0.0.4-conformant forms or to fail deterministically.

## ADP.1 Adapter Manifest Schema

```json
{
  "$id": "cah-0.0.4-adapter.schema.json",
  "title": "CAH Adapter Manifest",
  "type": "object",
  "properties": {
    "source_version": { "enum": ["0.0.1","0.0.2"] },
    "target_version": { "const": "0.0.4" },
    "rules": {
      "type": "array",
      "items": { "$ref": "#/$defs/rule" },
      "minItems": 1
    },
    "lossiness": {
      "type": "object",
      "properties": {
        "is_lossy": { "type": "boolean" },
        "notes": { "type": "string" }
      },
      "required": ["is_lossy"],
      "additionalProperties": false
    },
    "error_remap": {
      "type": "array",
      "items": { "$ref": "#/$defs/remap" }
    },
    "feature_flags": {
      "type": "array",
      "items": { "type": "string", "pattern": "^feat\\.[a-z0-9._-]+$" }
    }
  },
  "required": ["source_version","target_version","rules","lossiness"],
  "additionalProperties": false,
  "$defs": {
    "rule": {
      "type": "object",
      "properties": {
        "selector": { "type": "string" },
        "action": {
          "enum": [
            "rename_keyword","rewrite_operator","insert_port",
            "remove_token","normalize_whitespace","map_error_code",
            "promote_entity","downgrade_feature","reject"
          ]
        },
        "params": { "type": "object", "additionalProperties": true }
      },
      "required": ["selector","action"],
      "additionalProperties": false
    },
    "remap": {
      "type": "object",
      "properties": {
        "from": { "type": "string", "pattern": "^E-[A-Z]+-[0-9A-Za-z]{3}$" },
        "to": { "type": "string", "pattern": "^E-[A-Z]+-[0-9A-Za-z]{3}$" },
        "note": { "type": "string" }
      },
      "required": ["from","to"],
      "additionalProperties": false
    }
  }
}
```

## ADP.2 Required Transform Classes

- **Keyword normalization**: rename legacy tokens to 0.0.4 registry (`E-SYN-104` avoidance).
- **Operator upgrades**: map legacy multi-char tokens into 0.0.4 operators (`OPEN_*`, `CLOSE_*`, `BR_*`, `DESC`) or reject.
- **Port synthesis**: if legacy diagrams implicitly crossed C-SP without explicit ports, either:

  - insert consistent port tokens where unambiguous (emit WARN), or
  - fail with `E-PREC-802` if ambiguous.
- **Fence canonicalization**: coerce legacy spacing to `TRIPLE-V` and `FIVE-V`.
- **Parity defaults**: if thresholds/ratio absent, inject `θ_emo=1.00`, `θ_phl=1.00`, `ρ=0.67` (emit WARN).
- **Unit alignment**: attach/convert units to UR base; otherwise `E-NORM-A03`.

## ADP.3 Lossiness & Determinism

- An adapter MUST declare `lossiness.is_lossy=true` if any semantic ambiguity is resolved by convention (e.g., inferring port direction).
- If deterministic resolution is impossible, the adapter MUST use `action="reject"` and emit `E-PREC-801` with `note:"non-portable-legacy"`.

## ADP.4 Error Remapping (legacy → 0.0.4)

- Implement a mapping table in `error_remap` to ensure CI comparability.
- Remaps MUST be 1:1 and injective within an adapter; collisions are forbidden.

## ADP.5 Validation After Adaptation

- After applying rules, the resulting artifact MUST pass **full 0.0.4 validation** or fail with explicit codes; adapters MUST NOT bypass ADS preconditions.

---
