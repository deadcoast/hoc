# T1 — Operator Legality Matrix

## T1.1 Context model

* **Columns:** `E_SC` (left lane), `M_SC` (C-SP, center), `P_SC` (right lane).
* **Zones within a row:** `PRE` (before first operator/term), `MID` (between terms), `POST` (after last term).
* **Vicinity:** `NEAR-NODE` (immediately adjacent to a node token), `NEAR-BORDER` (adjacent to `│`), `NEAR-BARRIER` (adjacent to prescribed `v` fences), `NEAR-DEF` (same row block as `DEF`).

## T1.2 Token classes

* **Operators:** `OPEN_L(<+)`, `OPEN_R(+>)`, `CLOSE_L(-<)`, `CLOSE_R(>-)`, `BR_L(<)`, `BR_R(>)`, `DESC(v)`.
* **Terms:** `VAR(EV_ID|PV_ID)`, `NODE(ABT)`, `SPAN_ANCHOR(ε)`.

## T1.3 Placement legality by column

| Operator  | E_SC                                                          | M_SC                                                           | P_SC                                                                  |
| --------- | ------------------------------------------------------------- | -------------------------------------------------------------- | --------------------------------------------------------------------- |
| `OPEN_L`  | **ALLOWED** (bind into C-SP)                                  | **ALLOWED** (left-directed open within C-SP)                   | **FORBIDDEN**                                                         |
| `OPEN_R`  | **FORBIDDEN**                                                 | **ALLOWED** (right-directed open within C-SP)                  | **ALLOWED** (bind into C-SP)                                          |
| `CLOSE_L` | **ALLOWED** (return from C-SP)                                | **ALLOWED** (left-directed close within C-SP)                  | **FORBIDDEN**                                                         |
| `CLOSE_R` | **FORBIDDEN**                                                 | **ALLOWED** (right-directed close within C-SP)                 | **ALLOWED** (return from C-SP)                                        |
| `BR_L`    | **ALLOWED** (neutral branch left within lane)                 | **ALLOWED** (redistribute left within C-SP where ports exist)  | **FORBIDDEN** (cannot branch further right→left across P_SC boundary) |
| `BR_R`    | **FORBIDDEN** (cannot branch left→right across E_SC boundary) | **ALLOWED** (redistribute right within C-SP where ports exist) | **ALLOWED** (neutral branch right within lane)                        |
| `DESC`    | **ALLOWED**                                                   | **ALLOWED**                                                    | **ALLOWED**                                                           |

> **Note:** “ALLOWED in M_SC where ports exist” means the diagram must present a permissible lateral junction; otherwise treat as **FORBIDDEN**.

## T1.4 Adjacency rules (operator–term/operator–operator)

| Left token → Right token | LEGALITY      | Notes                                                      |
| ------------------------ | ------------- | ---------------------------------------------------------- |
| `OPEN_*` → `TERM`        | **REQUIRED**  | Opener must be followed by a term in the same row segment. |
| `TERM` → `CLOSE_*`       | **PERMITTED** | Closes most-recent opener on that side (stack discipline). |
| `OPEN_*` → `OPEN_*`      | **FORBIDDEN** | Must insert a term between openers.                        |
| `CLOSE_*` → `CLOSE_*`    | **PERMITTED** | Multi-close allowed; order must respect nesting.           |
| `BR_*` → `TERM`          | **PERMITTED** | Neutral branch must be followed by a term.                 |
| `TERM` → `BR_*`          | **PERMITTED** | Branch may follow a term.                                  |
| `BR_*` → `BR_*`          | **FORBIDDEN** | No chained branch without intermediate term.               |
| `CLOSE_*` → `OPEN_*`     | **PERMITTED** | Close then re-open allowed.                                |
| `OPEN_*` → `CLOSE_*`     | **FORBIDDEN** | Empty span disallowed.                                     |
| `DESC` → any             | **FENCE**     | See T4 fences; nothing may commute across a fence.         |
| any → `DESC`             | **FENCE**     | As above.                                                  |

## T1.5 Zone constraints

* **PRE:** `OPEN_*`, `BR_*`, `DESC`, or a `TERM` MAY start a segment; `CLOSE_*` MAY start only if there is a pending opener earlier in the same span group.
* **MID:** all legal pairs per T1.4; parser enforces nesting.
* **POST:** no operator may appear after `DEF` row block begins; only `DESC` fences may follow within the block as prescribed by the diagram.

## T1.6 Vicinity constraints

* **NEAR-NODE:**

  * `ABT` MAY be used as a `TERM` target.
  * Other nodes MUST NOT appear in `FLOW_EXPR`.
  * `OPEN_*` immediately adjacent to `ABT` is **PERMITTED**; `CLOSE_*` adjacent to `DEF` is **FORBIDDEN** (must close before DEF block).
* **NEAR-BORDER (`│`):** No token may straddle a border; operators must be wholly within a segment.
* **NEAR-BARRIER:** No reordering across `DESC` fences.
* **NEAR-DEF:** Within the `DEF` row block, only validated, span-closed ingress is permitted; all operators are **FORBIDDEN** except diagram-prescribed `DESC` fences.

## T1.7 Operator legality matrix (summary codes)

* `L`: Allowed, `P`: Allowed with port, `F`: Forbidden.

| Op\Col  | E_SC | M_SC | P_SC |
| ------- | ---: | ---: | ---: |
| OPEN_L  |    L |    L |    F |
| OPEN_R  |    F |    L |    L |
| CLOSE_L |    L |    L |    F |
| CLOSE_R |    F |    L |    L |
| BR_L    |    L |    P |    F |
| BR_R    |    F |    P |    L |
| DESC    |    L |    L |    L |

---

## T3 — Normalization Registry (Interface & Contracts)

## T3.1 Purpose

Provide deterministic mapping from heterogeneous raw measures to unitless comparable magnitudes for parity evaluation.

## T3.2 Entities

* **`NormalizerID`**: stable string key (e.g., domain-scoped).
* **`Domain`**: categorical scope of a variable family (e.g., sleep, exertion).
* **`Unit`**: declared unit string (SI preferred; dimensionless allowed).
* **`Policy`**: directionality/monotonicity and clipping strategy.
* **`Params`**: versioned parameter set for the mapping function.
* **`Version`**: semantic version string pinned to spec version.

## T3.3 API (pure abstract)

* `register_normalizer(NormalizerID, Domain, Unit, Policy, Params, Version)` → `OK|E-NORM-REGISTER`
* `resolve_normalizer(EV_ID|PV_ID)` → `NormalizerID|E-NORM-RESOLVE`
* `normalize(NormalizerID, scale_raw: ℝ, unit: Unit, conf: [0,1], dir: {−1,0,+1})`
  → `{scale_norm: ℝ⁺, conf: [0,1], dir: {−1,0,+1}} | E-NORM-*`
* `list_normalizers(Domain?)` → catalog (for validation/reporting)
* `get_params(NormalizerID)` → immutable view of parameterization

## T3.4 Mapping contract

* **Function form:** `scale_norm = f(scale_raw; Params, Policy)`

  * `f` MUST be **monotone** under the Policy’s expected direction (e.g., “lower is better” vs “higher is better”).
  * `f` MUST produce `ℝ⁺ ∪ {0}`; negatives forbidden post-norm.
* **Confidence propagation:** output `conf_out = conf_in` (pass-through).
* **Directionality:** `dir_out = dir_in` (no inversion by normalizer).
* **Clipping:** apply Policy bounds `[min,max]`; behavior must be one of: `CLIP`, `SATURATE`, or `REJECT` with explicit selection in Policy.
* **Determinism:** same inputs → same outputs; no stochastic terms.
* **Auditability:** parameters and policy must be serializable in `validation` block.

## T3.5 Resolution rules

* Each `EV_ID`/`PV_ID` MUST resolve to exactly one `NormalizerID`.
* Missing mapping triggers `E-PARITY-NORMALIZER`.
* Unit mismatch (`unit` not equal to normalizer’s expected unit) triggers `E-NORM-UNIT`.

## T3.6 Versioning & compatibility

* Normalizers carry `Version` and MUST be compatible with `spec_version=0.0.4`.
* Upgrades are additive; breaking changes require a new `NormalizerID`.

## T3.7 Constants (v0.0.4 defaults)

* **Thresholds:** `θ_emo = 1.00`, `θ_phl = 1.00`.
* **Balance ratio:** `ρ = 0.67` (weaker side must be ≥ 67% of stronger side).
* These are required defaults unless explicitly overridden by a validated configuration block.

---

## T7 — Error Catalogue (Complete, Initial Release)

## T7.1 Code ranges

* **Syntax:** `E-SYN-1xx`
* **Layout:** `E-LYT-2xx`
* **Span:** `E-SPAN-3xx`
* **Routing:** `E-ROUTE-4xx`
* **Parity:** `E-PARITY-5xx`
* **Barrier:** `E-BARRIER-6xx`
* **Commit/DEF:** `E-DEF-7xx`
* **Precedence/Diagram:** `E-PREC-8xx`
* **Versioning/Compat:** `E-VERSION-9xx`
* **Normalization:** `E-NORM-Axx` (hex A-series reserved for registry)

## T7.2 Enumerated errors (non-exhaustive but normative)

**Syntax (`E-SYN`)**

* `E-SYN-101` Unknown token.
* `E-SYN-102` Unbalanced brackets/parentheses/braces.
* `E-SYN-103` Forbidden TAB character.
* `E-SYN-104` Illegal keyword (not in registry).
* `E-SYN-105` Illegal operator composition.

**Layout (`E-LYT`)**

* `E-LYT-201` Token straddles column border `│`.
* `E-LYT-202` Port-required lateral redistribution without diagrammed port.
* `E-LYT-203` Frame characters embedded within semantic segment.

**Span (`E-SPAN`)**

* `E-SPAN-301` Unmatched opener `OPEN_*`.
* `E-SPAN-302` Unmatched closer `CLOSE_*`.
* `E-SPAN-303` Improper nesting (violates stack discipline).
* `E-SPAN-304` Empty span (`OPEN_*` immediately followed by `CLOSE_*`).
* `E-SPAN-305` Payload attachment after closure.
* `E-SPAN-306` Illegal crossing (span path violates column constraints).
* `E-SPAN-307` Side/type mismatch in payload binding.

**Routing (`E-ROUTE`)**

* `E-ROUTE-401` Crossing C-SP without required `OPEN_*`.
* `E-ROUTE-402` Egress from C-SP without required `CLOSE_*`.
* `E-ROUTE-403` BRANCH chain without term.
* `E-ROUTE-404` Illegal horizontal branch (no port in diagram).

**Parity (`E-PARITY`)**

* `E-PARITY-501` Missing side (no `ev*` or no `pv*`).
* `E-PARITY-502` Threshold not met (`θ` failure).
* `E-PARITY-503` Balance ratio failure (`ρ`).
* `E-PARITY-504` Normalizer unresolved.
* `E-PARITY-505` Normalizer rejected input (policy REJECT).

**Barrier (`E-BARRIER`)**

* `E-BARRIER-601` Operator commuted across `DESC` fence.
* `E-BARRIER-602` Span state mutated across barrier without traversal allowance.

**Commit/DEF (`E-DEF`)**

* `E-DEF-701` Unclosed span reached DEF.
* `E-DEF-702` Non-parity-validated payload presented at DEF.
* `E-DEF-703` Operator present in DEF vicinity.
* `E-DEF-704` Multiple commits in single evaluation tick (no atomic boundary).

**Precedence/Diagram (`E-PREC`)**

* `E-PREC-801` Text–diagram divergence; diagram supremacy applied.
* `E-PREC-802` Illegal operator where diagram lacks structural port.

**Versioning (`E-VERSION`)**

* `E-VERSION-901` Missing or wrong `spec_version`.
* `E-VERSION-902` Incompatible normalizer version.

**Normalization (`E-NORM`)**

* `E-NORM-A01` Normalizer registration failure.
* `E-NORM-A02` Normalizer resolution failure.
* `E-NORM-A03` Unit mismatch.
* `E-NORM-A04` Out-of-bounds value under policy.
* `E-NORM-A05` Non-monotonic mapping detected (validation).

Each error MUST include: `code`, `row`, `column`, `severity ∈ {ERROR,WARN}`, `message`.

---
