# [1] Status audit

## Already specified (solid baseline)

* **Grammar (core)**: lexical tokens, operators, nodes, lanes, payloads, columns, segments, flow expressions, ordering constraints, well-formedness.
* **Node I/O contracts**: CHO, ACT, DEC, ABT, DEF.
* **Span object**: creation/identity, shape/scope, payload binding, closure rules, concurrency, state machine, span-specific errors.

## Missing or requiring expansion

1. **Operator algebra & validity table**

   * Formal operator precedence/associativity, legal adjacency matrix, inside/outside C-SP legality, crossing semantics, barrier interaction, and illegal compound detection.

2. **C-SP routing & aggregation rules**

   * Addressing, legal transitions among E-SC/M-SC/P-SC, fan-in/fan-out constraints, deterministic merge semantics, and column conflict resolution.

3. **MD-flo parity specification**

   * Formal parity contract, metric schema, normalization rules, acceptance thresholds, and failure classes (non-admitting conditions at ABT).

4. **“v v v” and “vvvvv” descent semantics**

   * Clocking model, synchronization/barrier semantics, counter-exactness, effects on operator scheduling and span traversal.

5. **Serialization schema**

   * Canonical on-wire format, version pinning, canonical ordering, stable hashing fields, column addressing, span encoding, and round-trip fidelity guarantees.

6. **Validation suite (semantic)**

   * Static checks beyond grammar: parity, column-side type checks, span well-nestedness across rows, legal adjacency, barrier compliance.

7. **Error model (global)**

   * System-wide error catalogue and codes (we only have span errors); add syntax, parity, gate, commit, layout, barrier errors, and severity.

8. **Versioning & precedence**

   * Version fields, forward/back compat policy, feature flags, and explicit “diagram > text” enforcement step.

9. **Whitespace & layout constraints**

   * Grid/monospace requirements, token spacing, line numbering status, framing glyphs normative/ignored boundaries.

10. **Notation registry (final)**

    * Reserved keywords/symbols table, forbidden aliases, future-reserved set.

11. **Timing & concurrency**

    * Phase ticks, hazards, tie-breakers at simultaneous closures, and barrier/flush rules.

## [2] Tasklist

* **T1. Operator algebra & validity table**
  Define precedence, associativity, legal/illegal sequences, C-SP crossing legality, barrier effects.

* **T2. C-SP routing/aggregation**
  Define column addressing, legal transitions, merge semantics, conflict rules.

* **T3. MD-flo parity spec**
  Define metric schema, normalization, acceptance thresholds, failure classes.

* **T4. Descent markers (“v v v” / “vvvvv”)**
  Define clocking/barrier semantics and scheduling impact.

* **T5. Serialization schema (v0.0.4)**
  Define canonical JSON structure, ordering, versioning, span encoding, hashing inputs.

* **T6. Validation suite (semantic rules)**
  Define all non-grammatical validators and pass/fail conditions.

* **T7. Error model (global)**
  Publish code list, class hierarchy, severity, and node/operator mapping.

* **T8. Versioning & precedence**
  Pin fields and compat rules; encode diagram supremacy as a validation step.

* **T9. Whitespace/layout constraints**
  Lock grid/spacing rules; enforceable constraints for renderers/parsers.

* **T10. Notation registry (final)**
  Publish reserved/forbidden tables with future-reserved slots.

* **T11. Timing & concurrency**
  Formalize tick phases, simultaneous events, and deterministic tie-breakers.

## [3] Next Tasks

## T1. Operator algebra & validity table

### T1.1 Precedence (highest → lowest)

1. **DESC** (`v`) — scheduling token; binds to row progression.
2. **OPENers** (`<+`, `+>`) — span creation and C-SP binding.
3. **CLOSErs** (`-<`, `>-`) — span sealing and payload freeze.
4. **BRANCH** (`<`, `>`) — neutral redirection without binding.

### T1.2 Associativity

* **OPENers**: right-associative within a row; nearest subject binds first.
* **CLOSErs**: left-associative; close the most recent open on the same side (stack discipline).
* **BRANCH**: left-associative; evaluated after all pending OPEN/CLOSE at that position.
* **DESC**: non-associative; advances scheduling position and may trigger barriers (see T4).

### T1.3 Legality by context

* Inside C-SP crossings:

  * `OPEN_L` and `OPEN_R` are **required** to bring payload across a C-SP boundary.
  * `CLOSE_*` must occur **before** egress to DEF.
* Outside C-SP:

  * `OPEN_*` optional unless the path intends to cross into C-SP.
  * `CLOSE_*` illegal without a matching open on the same side.
* Inline node adjacency:

  * `NODE_ABT` MAY appear as a term in a `FLOW_EXPR`.
  * Other nodes MUST NOT appear in `FLOW_EXPR`.

### T1.4 Illegal compound sequences (non-exhaustive)

* `+>` immediately followed by `<+` without intervening TERM.
* `>-` immediately followed by `-<` targeting the opposite side within the same operator slot.
* Any `CLOSE_*` with no outstanding `OPEN_*` on that side.
* `OPEN_*` targeting both sides within a single operator token.
* `BRANCH` into DEF path without meeting closure prerequisites.

### T1.5 Barrier interaction

* Where a descent barrier is prescribed, **no operator reordering** may cross the barrier. Operators must be fully evaluated up to the barrier before continuing.

---

## T2. C-SP routing & aggregation rules

### T2.1 Addressing

* Columns: `E_SC`, `M_SC`, `P_SC`.
* A **route** is a sequence of segment positions across rows that preserves column alignment except at C-SP boundaries where an `OPEN_*` or `CLOSE_*` permits crossing/binding.

### T2.2 Legal transitions

* **Lane → C-SP:** requires `OPEN_L` from E_SC or `OPEN_R` from P_SC.
* **C-SP → Lane:** requires `CLOSE_L` to E_SC or `CLOSE_R` to P_SC.
* **Within C-SP (M_SC):** `BRANCH` may redistribute flows **horizontally** only where the diagram provides explicit ports; otherwise, neutral branches remain within column.

### T2.3 Aggregation (fan-in)

* When multiple flows converge in **M_SC**, the merge operator is **deterministic union** of payload bindings by identifier, preserving side tags.
* Duplicate identifiers coalesce; order is not semantically meaningful after aggregation.

### T2.4 Fan-out

* Neutral `BRANCH` MAY duplicate routing state; payload references remain aliases, not copies. Binding remains single-source in parity evaluation.

### T2.5 Conflicts

* Contradictory column claims (e.g., `EV_ID` observed on P_SC) constitute a **type error** and invalidate the route segment.

---

## T3. MD-flo parity specification

### T3.1 Parity contract

* A payload set **qualifies** at ABT only if both:

  * At least one **emotional** identifier (`ev*`) is present, and
  * At least one **physical** identifier (`pv*`) is present,
  * And both sides pass metric thresholds after normalization.

### T3.2 Metric schema

* Each identifier binds a **metric triple** at evaluation time:

  * `scale` ∈ ℝ⁺ (magnitude in its native unit)
  * `conf` ∈ [0,1] (confidence)
  * `dir`  ∈ {+1, 0, −1} (directionality: constructive/neutral/destructive)
* Normalization maps heterogeneous units to **unitless** comparable magnitudes via a registered normalizer (registry is external to this slice).

### T3.3 Acceptance thresholds

* Side aggregates computed as:

  * `S_emo = Σ (scale_norm * conf * max(dir,0))` over all `ev*`
  * `S_phl = Σ (scale_norm * conf * max(dir,0))` over all `pv*`
* **Admit** iff:

  * `S_emo ≥ θ_emo` and `S_phl ≥ θ_phl`, with θ constants version-pinned to 0.0.4,
  * and `min(S_emo, S_phl) / max(S_emo, S_phl) ≥ ρ` (balance ratio).
* Failing any condition yields a **parity failure** at ABT.

### T3.4 Failure classes (at ABT)

* `E-PARITY-501` (no `ev*` or no `pv*`)
* `E-PARITY-502` (one side below θ)
* `E-PARITY-503` (ratio below ρ)
* `E-PARITY-504` (missing/invalid normalization path)

---

## T4. Descent markers (“v v v” / “vvvvv”) — semantics

### T4.1 Triple-V (`v     v     v`)

* Denotes **synchronous descent** events emitted to `E_SC`, `M_SC`, `P_SC` at a single tick.
* Acts as a **start barrier**: downstream nodes may assume presence of a descent token per column before processing.

### T4.2 Five-V (`vvvvv`)

* Denotes a **multi-tick descent window** within M_SC used as a **synchronization barrier** for span operations.
* Operators queued before the window must complete evaluation; operators after the window may not inspect or mutate span state created beyond it.

### T4.3 Scheduling effects

* Descent markers are **ordering fences**. No operator may commute across a fence during evaluation.

---

## T5. Serialization schema (v0.0.4, canonical)

### T5.1 Envelope

* `version`: string, exactly `"0.0.4"`
* `diagram_digest`: stable hash of the normalized diagram glyph stream
* `nodes`: ordered list of node records
* `spans`: ordered list of span records
* `payloads`: side-keyed identifier table
* `validation`: results summary (optional in authoring; mandatory in committed outputs)

### T5.2 Node record

* `id`: stable node id (CHO|ACT|DEC|ABT|DEF with occurrence index if repeated)
* `column`: one of `E_SC|M_SC|P_SC` (DEF is `M_SC`)
* `row`: integer (1-based, normalized after frame stripping)

### T5.3 Span record

* `span_id`: integer (creation order)
* `side`: `LEFT|RIGHT`
* `open`: `{row, column, offset}`
* `close`: `{row, column, offset}`
* `payload_refs`: `{emo: [EV_ID…], phl: [PV_ID…]}`
* `route_ok`: boolean (post-validation)

### T5.4 Payloads

* `emo`: object mapping `EV_ID` → `{scale, conf, dir}`
* `phl`: object mapping `PV_ID` → `{scale, conf, dir}`

### T5.5 Canonical ordering & hashing

* Keys sorted lexicographically; arrays sorted by insertion index.
* `diagram_digest` computed over: stripped framing, normalized spaces, preserved token order.

---

## T6. Validation suite (semantic rules)

### T6.1 Classes

* `SEM-SPAN` (span structure), `SEM-SIDE` (side typing), `SEM-PARITY` (MD-flo), `SEM-ROUTE` (routing legality), `SEM-BARRIER` (descent fences), `SEM-DEF` (pre-commit invariants).

### T6.2 Rules (selected)

* `SEM-SPAN-01` Every `OPEN_*` has matching `CLOSE_*` before any path to DEF.
* `SEM-SIDE-01` `EV_ID` must originate/bind on `E_SC`; `PV_ID` on `P_SC`.
* `SEM-PARITY-01` ABT admits only if §T3 acceptance conditions pass.
* `SEM-ROUTE-01` No illegal C-SP crossings without `OPEN_*`.
* `SEM-BARRIER-01` No operator reordering across `v` fences.
* `SEM-DEF-01` DEF input set contains only parity-validated, span-closed payloads.

---

## T7. Error model (global, initial catalogue)

* **Syntax**: `E-SYN-*` (tokenization/grammar)
* **Layout**: `E-LYT-*` (grid/spacing)
* **Span**: `E-SPAN-*` (as defined; extended to global table)
* **Parity**: `E-PARITY-*` (from T3)
* **Routing**: `E-ROUTE-*`
* **Barrier**: `E-BARRIER-*`
* **Commit**: `E-DEF-*`

Each error carries: `code`, `row`, `column`, `severity ∈ {ERROR, WARN}`, `message`.

---

## T8. Versioning & precedence

* `spec_version`: `"0.0.4"` required in serialized form.
* **Precedence rule** (enforced during validation): `DIAGRAM_SUPREMACY = true`.
  * If derived text conflicts with the diagram glyph stream, validator MUST conform to the diagram, flagging `E-PREC-801` as a warning.

---

## T9. Whitespace & layout constraints

* Monospace grid required; `TAB` forbidden.
* Single `SP` between composed `v` markers.
* Frame glyphs are non-semantic; parsers must strip them before normalization.
* Line numbers (if present) are documentation-only and MUST NOT enter hashing.

---

## T10. Notation registry (finalize)

* **Reserved keywords**: `CHO, ACT, DEC, ABT, DEF, emo, phl, ent`.
* **Reserved symbols**: `v, <, >, +, -, (, ), {, }, [, ], !, :, │`.
* **Forbidden aliases**: `ATN, var, vb2` and any non-`ev*`/`pv*` variable prefix.
* **Future-reserved**: `met*` (metrics), `norm*` (normalizers).

---

## T11. Timing & concurrency (initial)

* **Phase ticks**: `CHO→ACT→DEC→ABT→DEF` are ordered barriers.
* **Simultaneity**: concurrent closures at a row are ordered left-to-right within the row.
* **Tie-break**: if simultaneous across columns, order `E_SC, M_SC, P_SC`.

---
