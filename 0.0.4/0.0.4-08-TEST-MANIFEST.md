# CTM — Conformance Test Manifest Schema (Machine-Runnable)

## CTM.1 Purpose

Define a machine-readable manifest for validators/renders to execute deterministic tests covering parsing, routing, spans, parity, normalization, barriers, DEF, serialization, digest, and diagram supremacy.

## CTM.2 Top-Level JSON Schema

```json
{
  "$id": "cah-0.0.3-conformance-test-manifest.schema.json",
  "title": "CAH Conformance Test Manifest",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.3" },
    "suite_id": { "type": "string", "pattern": "^[a-z0-9._-]{3,64}$" },
    "metadata": {
      "type": "object",
      "properties": {
        "description": { "type": "string" },
        "created": { "type": "string", "format": "date-time" },
        "updated": { "type": "string", "format": "date-time" },
        "author": { "type": "string" },
        "spec_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      },
      "required": ["description"],
      "additionalProperties": false
    },
    "defaults": {
      "type": "object",
      "properties": {
        "options": {
          "type": "object",
          "properties": {
            "strict": { "type": "boolean", "default": true },
            "coerce_older_versions": { "type": "boolean", "default": false },
            "emit_warnings": { "type": "boolean", "default": true }
          },
          "additionalProperties": false
        },
        "thresholds": {
          "type": "object",
          "properties": {
            "theta_emo": { "type": "number", "minimum": 0, "default": 1.0 },
            "theta_phl": { "type": "number", "minimum": 0, "default": 1.0 },
            "balance_ratio": { "type": "number", "exclusiveMinimum": 0, "maximum": 1, "default": 0.67 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "normalizer_catalog": { "$ref": "cah-0.0.3-normalizer-catalog.schema.json#" },
    "tests": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/test_case" }
    }
  },
  "required": ["version","suite_id","metadata","tests"],
  "additionalProperties": false,
  "$defs": {
    "test_case": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9._-]{3,64}$" },
        "title": { "type": "string" },
        "category": {
          "enum": [
            "LEX","PARSE","LAYOUT","PORTS","ROUTE","SPAN","SIDE",
            "BARRIER","NORM","PARITY","ABT","DEF","SERIALIZE","DIGEST","PREC","VERSION","PERF"
          ]
        },
        "intent": { "enum": ["POSITIVE","NEGATIVE","WARN_ONLY","PERF_BOUND"] },
        "inputs": {
          "type": "object",
          "properties": {
            "diagram_text": { "type": "string" },
            "serialized_json": { "type": ["object","null"] },
            "options": {
              "type": "object",
              "properties": {
                "strict": { "type": "boolean" },
                "coerce_older_versions": { "type": "boolean" },
                "emit_warnings": { "type": "boolean" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "expect": {
          "type": "object",
          "properties": {
            "passed": { "type": "boolean" },
            "diagram_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
            "nodes_present": {
              "type": "array",
              "items": { "enum": ["CHO","ACT","DEC","ABT","DEF"] },
              "uniqueItems": true
            },
            "ports_present": {
              "type": "array",
              "items": { "enum": ["P_E1","P_P1","P_M1","P_A1"] },
              "uniqueItems": true
            },
            "spans": {
              "type": "object",
              "properties": {
                "min": { "type": "integer", "minimum": 0 },
                "max": { "type": "integer", "minimum": 0 }
              },
              "additionalProperties": false
            },
            "payloads": {
              "type": "object",
              "properties": {
                "emo_ids": { "type": "array", "items": { "type": "string", "pattern": "^ev[a-z0-9_]+$" } },
                "phl_ids": { "type": "array", "items": { "type": "string", "pattern": "^pv[a-z0-9_]+$" } }
              },
              "additionalProperties": false
            },
            "thresholds": {
              "type": "object",
              "properties": {
                "theta_emo": { "type": "number", "minimum": 0 },
                "theta_phl": { "type": "number", "minimum": 0 },
                "balance_ratio": { "type": "number", "exclusiveMinimum": 0, "maximum": 1 }
              },
              "additionalProperties": false
            },
            "diagnostics": {
              "type": "array",
              "items": { "$ref": "#/$defs/diag_expect" }
            },
            "json_pointers_required": {
              "type": "array",
              "items": { "type": "string" }  // RFC-6901 pointers expected to appear
            },
            "performance": {
              "type": "object",
              "properties": {
                "max_rows": { "type": "integer", "minimum": 1 },
                "max_spans": { "type": "integer", "minimum": 0 },
                "time_ms": { "type": "number", "minimum": 0 },
                "memory_mb": { "type": "number", "minimum": 0 }
              },
              "additionalProperties": false
            }
          },
          "required": ["passed"],
          "additionalProperties": false
        }
      },
      "required": ["id","title","category","intent","inputs","expect"],
      "additionalProperties": false
    },
    "diag_expect": {
      "type": "object",
      "properties": {
        "code": { "type": "string", "pattern": "^E-[A-Z]+-[0-9A-Za-z]{3}$" },
        "severity": { "enum": ["ERROR","WARN"] },
        "phase": { "pattern": "^P-[A-Z]+$" },
        "min_count": { "type": "integer", "minimum": 0 },
        "max_count": { "type": "integer", "minimum": 999999 },
        "require_diagram_loc": { "type": "boolean" },
        "require_json_ptr": { "type": "boolean" }
      },
      "required": ["code","severity","min_count"],
      "additionalProperties": false
    }
  }
}
```

## CTM.3 Execution Semantics

* Runner MUST honor validator **phase graph** (V1.3) and **stop-on-error per phase** unless `inputs.options.strict=false`.
* `expect.diagnostics` defines **multiplicity** constraints per error code; absence implies zero occurrences.
* If `expect.diagram_digest` is provided, runner MUST compare against computed digest post-RCA.
* `performance` assertions apply only when `category="PERF"` or when present and `intent!="NEGATIVE"`.

---

## VCT — Versioned Changelog Template (Normative)

## VCT.1 Goals

Provide both **human-readable** and **machine-readable** change tracking for CAH versions, including normative changes that affect validation, serialization, and legality matrices.

## VCT.2 Machine-Readable Changelog Schema

```json
{
  "$id": "cah-0.0.3-changelog.schema.json",
  "title": "CAH Versioned Changelog",
  "type": "object",
  "properties": {
    "spec_series": { "const": "CAH" },
    "current_version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
    "entries": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
          "release_date": { "type": "string", "format": "date" },
          "stability": { "enum": ["alpha","beta","rc","stable","deprecated"] },
          "compatibility": { "enum": ["backward","forward","breaking"] },
          "digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
          "highlights": { "type": "array", "items": { "type": "string" } },
          "normative_changes": {
            "type": "object",
            "properties": {
              "grammar": { "type": "array", "items": { "type": "string" } },
              "operator_algebra": { "type": "array", "items": { "type": "string" } },
              "csp_routing": { "type": "array", "items": { "type": "string" } },
              "parity_metrics": { "type": "array", "items": { "type": "string" } },
              "descent_fences": { "type": "array", "items": { "type": "string" } },
              "serialization": { "type": "array", "items": { "type": "string" } },
              "validation_rules": { "type": "array", "items": { "type": "string" } },
              "error_catalog": { "type": "array", "items": { "type": "string" } },
              "versioning_precedence": { "type": "array", "items": { "type": "string" } },
              "whitespace_layout": { "type": "array", "items": { "type": "string" } },
              "notation_registry": { "type": "array", "items": { "type": "string" } },
              "timing_concurrency": { "type": "array", "items": { "type": "string" } },
              "ports": { "type": "array", "items": { "type": "string" } },
              "legality_schema": { "type": "array", "items": { "type": "string" } }
            },
            "additionalProperties": false
          },
          "deprecations": {
            "type": "array",
            "items": { "type": "string" }
          },
          "removals": {
            "type": "array",
            "items": { "type": "string" }
          },
          "migrations": {
            "type": "array",
            "items": { "type": "string" }
          },
          "tests_updated": {
            "type": "object",
            "properties": {
              "added": { "type": "array", "items": { "type": "string" } },
              "modified": { "type": "array", "items": { "type": "string" } },
              "removed": { "type": "array", "items": { "type": "string" } }
            },
            "additionalProperties": false
          },
          "thresholds": {
            "type": "object",
            "properties": {
              "theta_emo": { "type": "number" },
              "theta_phl": { "type": "number" },
              "balance_ratio": { "type": "number" }
            },
            "additionalProperties": false
          },
          "registry_updates": {
            "type": "object",
            "properties": {
              "reserved_keywords": { "type": "array", "items": { "type": "string" } },
              "reserved_symbols": { "type": "array", "items": { "type": "string" } },
              "future_reserved": { "type": "array", "items": { "type": "string" } }
            },
            "additionalProperties": false
          },
          "compat_notes": { "type": "array", "items": { "type": "string" } },
          "security_notes": { "type": "array", "items": { "type": "string" } }
        },
        "required": ["version","stability","compatibility","normative_changes"],
        "additionalProperties": false
      }
    }
  },
  "required": ["spec_series","current_version","entries"],
  "additionalProperties": false
}
```

## VCT.3 Human-Readable Changelog Template (Markdown, Normative Sections)

* **Header**

  * Spec Series: `CAH`
  * Version: `<x.y.z>`
  * Release date: `<YYYY-MM-DD>`
  * Stability: `<alpha|beta|rc|stable|deprecated>`
  * Compatibility: `<backward|forward|breaking>`
  * Digest: `<sha256-of-spec-bundle>`
* **Highlights**

  * Bulleted list of top changes.
* **Normative Changes**

  * Grammar
  * Operator Algebra
  * C-SP Routing
  * Parity & Metrics
  * Descent Fences
  * Serialization & Digest
  * Validation Rules
  * Error Catalog
  * Versioning & Precedence
  * Whitespace & Layout
  * Notation Registry
  * Timing & Concurrency
  * Ports
  * Legality Schema
* **Deprecations**
* **Removals**
* **Migrations**
* **Thresholds**
* **Registry Updates**
* **Tests Updated** (Added / Modified / Removed)
* **Compatibility Notes**
* **Security Notes**

## VCT.4 Process Requirements

* Each release MUST provide both machine-readable (VCT.2) and human-readable (VCT.3) artifacts.
* `digest` MUST cover the **entire spec bundle** for that release (schemas, rule sets, registry, defaults).
* Breaking changes MUST increment **minor** or **major** per project policy; `compatibility="breaking"` MUST be explicit.

---
