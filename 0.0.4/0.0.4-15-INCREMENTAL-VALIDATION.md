# IVS — Incremental & Streaming Validation (Diff Scopes and Rules)

## IVS.0 Scope

Defines change detection, re-validation scopes, streaming constraints, and cache invalidation for partial or evolving documents without compromising determinism, parity, ABT/DEF contracts, or diagram supremacy.

## IVS.1 Concepts

* **Change Unit (CU):** the smallest atomic modification region (row-level).
* **Impact Region (IR):** minimal superset of CUs whose semantics may change due to ports, spans, or fences.
* **Incremental Ticket (IT):** a structured request to (re)validate a set of IRs.
* **Streaming Mode:** authoring state where rows may be incomplete; certain phases are deferred.

## IVS.2 Diff Model

* **CU granularity:** one **row** (including its three segments).
* **Change detection:** any edit that alters tokens, spacing (except non-semantic collapsible spaces), ports, fences, or positions within a row marks the row as **dirty**.
* **IR expansion rules (minimal):**

  1. **Span adjacency:** if a dirty row contains any `OPEN_*`/`CLOSE_*`, include contiguous rows until a balanced span state is achieved for both sides (`LEFT|RIGHT`).
  2. **Fence influence:** if a dirty row introduces/removes a **TRIPLE** or **FIVE** fence, include the nearest upstream/downstream rows bounded by node barriers (CHO/ACT/DEC/ABT/DEF) to preserve evaluation order.
  3. **Port coupling:** if a dirty row hosts a port (P_E1/P_P1/P_M1/P_A1), include adjacent rows that contain operators which rely on that port for legality checks.
  4. **Node rows:** any dirty node row (CHO/ACT/DEC/ABT/DEF) always includes itself plus directly adjacent rows above and below.

## IVS.3 Incremental Ticket (IT) Schema

```json
{
  "$id": "cah-0.0.4-incremental-ticket.schema.json",
  "title": "CAH Incremental Validation Ticket",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "ticket_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{8,128}$" },
    "diagram_digest_prev": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "dirty_rows": { "type": "array", "items": { "type": "integer", "minimum": 1 }, "minItems": 1 },
    "streaming": { "type": "boolean", "default": false },
    "options": {
      "type": "object",
      "properties": {
        "strict": { "type": "boolean", "default": true },
        "emit_warnings": { "type": "boolean", "default": true }
      },
      "additionalProperties": false
    }
  },
  "required": ["version","ticket_id","dirty_rows"],
  "additionalProperties": false
}
```

## IVS.4 Phase Eligibility by Mode

* **Incremental (non-streaming):**

  * Eligible phases within IR: **P-LEX → P-PREC**.
  * Global invariants that depend on outside-IR state (e.g., version) reuse cached results if unaffected.
* **Streaming:**

  * Immediate phases: **P-LEX, P-PARSE, P-LAYOUT, P-PORTS** within IR.
  * Deferred phases: **P-ROUTE → P-DEF** must not finalize; emit **draft diagnostics** (`severity:"WARN"`, code suffix `-DRAFT`) and set `passed=false` until streaming rows are sealed.

## IVS.5 Cache Invalidation & Reuse

* **Stable caches:** AST nodes, S-MAP rows, port detections, and indices outside IR are reused verbatim.
* **Invalidation triggers:** any CU in IR that changes **row length**, **port presence**, **fence presence**, or **node presence** invalidates cached legality decisions for adjacent rows per IVS.2.
* **Digest evolution:** recompute `diagram_digest` for the entire diagram only after non-streaming merge; during streaming, compute a **provisional digest** over present rows, flagged as `draft=true`.

## IVS.6 Determinism & Boundaries

* Incremental results MUST be **identical** to full validation results for the same final diagram.
* ABT/DEF are **disabled** in streaming mode; attempts to admit/commit must raise `E-DEF-702` (non-validated payload) with `draft=true` annotation.

---

## PVP — Privacy & Provenance (Redaction and Signing Blocks)

## PVP.0 Scope

Defines privacy grades, redaction policies for identifiers, and optional provenance signatures for serialized structures and commit objects. Extends ADS, NDM.

## PVP.1 Privacy Grades

* `privacy_grade ∈ {PG-0, PG-1, PG-2}`:

  * **PG-0:** no redaction; full identifiers.
  * **PG-1:** hashed identifiers; salts per document.
  * **PG-2:** tokenized identifiers; reversible only with external KMS.

## PVP.2 Redaction Policy Schema

```json
{
  "$id": "cah-0.0.4-privacy-policy.schema.json",
  "title": "CAH Privacy Policy",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "privacy_grade": { "enum": ["PG-0","PG-1","PG-2"] },
    "hash": {
      "type": "object",
      "properties": {
        "alg": { "enum": ["sha256"] },
        "salt": { "type": "string", "minLength": 16, "maxLength": 256 }
      },
      "additionalProperties": false
    },
    "tokenization": {
      "type": "object",
      "properties": {
        "kms_ref": { "type": "string" },
        "namespace": { "type": "string" }
      },
      "additionalProperties": false
    },
    "fields": {
      "type": "array",
      "items": { "enum": ["payloads.emo.*","payloads.phl.*","admission.*","provenance.*"] }
    }
  },
  "required": ["version","privacy_grade"],
  "additionalProperties": false
}
```

## PVP.3 Provenance Signature Block (Optional)

```json
{
  "$id": "cah-0.0.4-provenance-signature.schema.json",
  "title": "CAH Provenance Signature",
  "type": "object",
  "properties": {
    "alg": { "enum": ["ed25519","ecdsa-p256","rsa-pss-sha256"] },
    "key_id": { "type": "string" },
    "sig": { "type": "string", "pattern": "^[A-Za-z0-9+/=]+$" },
    "subject": {
      "type": "object",
      "properties": {
        "document_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "commit_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      },
      "additionalProperties": false
    },
    "issued_at": { "type": "string", "format": "date-time" }
  },
  "required": ["alg","key_id","sig","issued_at"],
  "additionalProperties": false
}
```

## PVP.4 Semantics

* Redaction applies **pre-serialization** for any exposed JSON. Commit `hash` (ADS.5.1) MUST be computed **after** redaction is applied to the commit payload if redaction is enabled; the unredacted canonical hash MAY also be stored out-of-band.
* Privacy grades MUST be recorded in `validation_report.provenance.privacy_grade`.
* Signatures MUST be over the canonical JSON (post-redaction) minus the signature block itself.

---

## NPS — Normalizer Pipelines (DAG Schema & Constraints)

## NPS.0 Scope

Defines composable normalizer pipelines applied to variable inputs prior to parity aggregation. Extends Normalizer Catalog (B.1), NDM, UR.

## NPS.1 Concepts

* **Stage:** a function that maps a numeric input to output with parameters.
* **Pipeline:** an **acyclic** directed graph of stages with a single entry and exit per side variable.
* **Contract:** each stage declares domain, unit expectations, and monotonicity.

## NPS.2 Stage Types (enum)

* `affine` — `y = a*x + b`
* `clip` — clamp to `[min,max]`
* `scale` — multiplicative-only scaling
* `log` — logarithmic transform with base and positive-domain constraint
* `sigmoid` — bounded monotonic mapping with parameters
* `zscore` — `(x - μ) / σ` with versioned μ, σ
* `exp_moving_avg` — smoothing with α and epoch constraints
* `custom` — vendor extension (feature-gated via FEA)

## NPS.3 Pipeline Schema

```json
{
  "$id": "cah-0.0.4-normalizer-pipeline.schema.json",
  "title": "CAH Normalizer Pipeline",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "pipeline_id": { "type": "string", "pattern": "^[a-z0-9._-]{3,64}$" },
    "stages": {
      "type": "array",
      "items": { "$ref": "#/$defs/stage" },
      "minItems": 1
    },
    "edges": {
      "type": "array",
      "items": { "$ref": "#/$defs/edge" }
    },
    "entry": { "type": "string" },   // stage id
    "exit": { "type": "string" },    // stage id
    "unit_in": { "type": "string" },
    "unit_out": { "type": "string" },
    "monotonic": { "type": "boolean" },
    "normalizer_version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
    "enabled": { "type": "boolean" }
  },
  "required": ["version","pipeline_id","stages","entry","exit","unit_in","unit_out","normalizer_version","enabled"],
  "additionalProperties": false,
  "$defs": {
    "stage": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9._-]{2,64}$" },
        "type": { "enum": ["affine","clip","scale","log","sigmoid","zscore","exp_moving_avg","custom"] },
        "params": { "type": "object", "additionalProperties": true },
        "domain": {
          "type": "object",
          "properties": {
            "min": { "type": "number" },
            "max": { "type": "number" }
          },
          "additionalProperties": false
        },
        "unit_in": { "type": "string" },
        "unit_out": { "type": "string" },
        "monotonic": { "type": "boolean" },
        "vendor_feature": { "type": "string" }
      },
      "required": ["id","type","unit_in","unit_out","monotonic"],
      "additionalProperties": false
    },
    "edge": {
      "type": "object",
      "properties": {
        "from": { "type": "string" },
        "to": { "type": "string" }
      },
      "required": ["from","to"],
      "additionalProperties": false
    }
  }
}
```

## NPS.4 Constraints & Validation

* **Acyclicity:** the graph over `stages` and `edges` MUST be a DAG; cycles → `E-NORM-A05`.
* **Unit continuity:** `unit_out` of a stage MUST equal `unit_in` of downstream stage; mismatch → `E-NORM-A03`.
* **Domain contract:** inputs MUST satisfy stage `domain`; violations → `E-NORM-A04`.
* **Monotonicity:** if `pipeline.monotonic=true`, every stage MUST be monotonic; otherwise raise `E-NORM-A05`.
* **Entry/Exit:** exactly one inbound edge to `entry` (from source) and one outbound edge from `exit` (to sink). Multiple branches require explicit **merge stage** (future reserved).
* **Versioning:** `normalizer_version.major == 0` under spec `0.0.4`.

## NPS.5 Integration with Catalog

* A catalog record may reference either:

  * a **simple normalizer** (legacy single-stage semantics), or
  * a **pipeline** by `pipeline_id`. Both MUST NOT be present simultaneously in a single record.
* Bindings (`emo`/`phl`) remain unchanged; outputs of pipelines feed `scale_norm` for parity.

---
