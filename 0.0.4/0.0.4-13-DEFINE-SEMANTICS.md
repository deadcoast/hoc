# ADS — ABT / DEF Semantics (Normative)

## ADS.0 Scope

Defines the **operational semantics** for the **ABT** gate and the **DEF** commit phase, including state model, evaluation judgements, pre/post-conditions, error mappings, determinism, and the commit object schema. This extends and depends on: operator legality, C-SP routing, MD-flo parity, descent fences, timing & concurrency, and serialization rules previously published.

---

## ADS.1 State Model

### ADS.1.1 Machine State

Let the validator/evaluator maintain state:

* `Σ = ⟨R, P, S, N, F, T⟩` where:

  * `R`: routing map (per row/segment) from S-MAP.
  * `P`: payload table with side-keyed identifiers and normalized metrics (post P-NORM).
  * `S`: span stack state per side (`LEFT|RIGHT`) and per `span_group`.
  * `N`: normalizer registry snapshot resolved for variables (immutable within run).
  * `F`: fence set with positions and kinds (`TRIPLE`, `FIVE`).
  * `T`: tick counter (phase barrier index), advancing through `CHO→ACT→DEC→ABT→DEF`.

### ADS.1.2 Derived Sets

* `E`: set of **eligible** payload bindings after routing and side-typing, partitioned as `E_emo` and `E_phl`.
* `O`: set of **open** spans in scope prior to ABT evaluation.
* `C`: set of **closed** spans available for DEF commit.
* `Ports(r)`: port classes available at row `r` (per T2).

---

## ADS.2 Judgements & Evaluation Order

### ADS.2.1 Primary Judgements

* **ABT admission**: `Σ ⊢ ABT ⇓ A`
  Produces an **admission record** `A` if and only if ABT pre-conditions and parity constraints hold; otherwise emits errors (`E-ROUTE-401/402`, `E-PARITY-5xx`) and no record.
* **DEF commit**: `Σ, A ⊢ DEF ⇓ D`
  Produces a **commit object** `D` atomically, provided closure and barrier constraints hold; otherwise emits errors (`E-DEF-701/702/703/704`) and no commit.

### ADS.2.2 Scheduling & Fences

* ABT evaluation executes **after** all operator effects up to and including the **FIVE-V** barrier in the ABT row scope.
* DEF executes **after** ABT in the same tick `T`, subject to **no operator presence** in the DEF block and **all spans closed**.

---

## ADS.3 ABT Gate — Preconditions, Semantics, Outcomes

### ADS.3.1 ABT Preconditions

1. **Port presence**: `P_A1 ∈ Ports(r_abt)` (ABT row has ABT-coupling port).
2. **Open spans**: `O ≠ ∅` and each ingress to ABT originates from an **open** span (`OPEN_L` and/or `OPEN_R`) in scope. Otherwise `E-ROUTE-401`.
3. **Side typing**: `E_emo ⊆ emo*` in `E_SC`, `E_phl ⊆ pv*` in `P_SC`. Violations → `E-SPAN-307`.
4. **Normalization**: every identifier in `E` resolves to exactly one normalizer; units match policy; values within bounds. Violations → `E-PARITY-504|E-NORM-A02|A03|A04`.
5. **Fence integrity**: no operator commutes across **TRIPLE** or **FIVE** fences contributing to the ABT scope. Violations → `E-BARRIER-601/602`.

### ADS.3.2 Parity & Metrics (MD-flo)

* Compute side aggregates `S_emo`, `S_phl` over `E_emo`, `E_phl` using version-pinned thresholds and ratio (T3.3–T3.7).
* **Admit condition**:
  `S_emo ≥ θ_emo` ∧ `S_phl ≥ θ_phl` ∧ `min(S_emo,S_phl)/max(S_emo,S_phl) ≥ ρ`.
  Else emit `E-PARITY-501|502|503` (as applicable) and **do not** admit.

### ADS.3.3 Admission Record

If admitted, produce `A = ⟨A_id, T, E*, M⟩`:

* `A_id`: monotonically increasing admission id (per document).
* `T`: tick at which admission occurs.
* `E*`: immutable snapshot of admitted payload bindings (identifiers, sides, normalized triples, and bound normalizer versions).
* `M`: metadata (diagram row/column coordinates, `diagram_digest`, port context, evaluator version).

### ADS.3.4 ABT Post-Conditions

* Admitted payloads become **eligible for DEF** in the same tick after **required closures** are satisfied.
* No mutation to `E*` is permitted after admission; subsequent operator effects cannot retroactively alter `A`.

---

## ADS.4 DEF Commit — Preconditions, Semantics, Outcomes

### ADS.4.1 DEF Preconditions

1. **Operator exclusion**: no operators present in the DEF block. Otherwise `E-DEF-703`.
2. **Closure completeness**: all spans that contributed to `A` are **closed** (`C` contains matching closes) **before** any DEF ingress line. Otherwise `E-DEF-701`.
3. **Validation completeness**: the validation suite up to and including **P-PARITY**, **P-ABT**, and **P-BARRIER** completed with **no ERROR** severities.
4. **Atomicity window**: only one commit operation per tick `T`. Attempted multiple commits in `T` → `E-DEF-704`.

### ADS.4.2 Commit Semantics

* **Atomic commit**: `Σ, A ⊢ DEF ⇓ D` constructs a single immutable **commit object** `D` (schema in ADS.5) from `A` and current structural context (nodes, spans, digests), then **appends** `D` to the DEF sink.
* **Determinism**: if the same `A` and structural context are presented, `D` is **byte-identical** across compliant implementations (subject to numeric determinism; see ADS.6.3).

### ADS.4.3 DEF Post-Conditions

* `D` is **read-only** and **addressable** by `(D.commit_id, D.hash)`.
* The evaluator advances `T := T + 1` after commit finalization.
* Any subsequent attempts to commit in the same `T` MUST fail with `E-DEF-704`.

---

## ADS.5 Commit Object Schema (Canonical)

```json
{
  "$id": "cah-0.0.3-def-commit.schema.json",
  "title": "CAH DEF Commit Object",
  "type": "object",
  "properties": {
    "spec_version": { "const": "0.0.3" },
    "commit_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{8,128}$" },
    "tick": { "type": "integer", "minimum": 0 },
    "diagram": {
      "type": "object",
      "properties": {
        "digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "row": { "type": "integer", "minimum": 1 },
        "column": { "const": "M_SC" }
      },
      "required": ["digest","row","column"],
      "additionalProperties": false
    },
    "admission": {
      "type": "object",
      "properties": {
        "admission_id": { "type": "string" },
        "tick": { "type": "integer", "minimum": 0 }
      },
      "required": ["admission_id","tick"],
      "additionalProperties": false
    },
    "payload_snapshot": {
      "type": "object",
      "properties": {
        "emo": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "scale_norm": { "type": "number" },
              "conf": { "type": "number", "minimum": 0, "maximum": 1 },
              "dir": { "enum": [-1,0,1] },
              "normalizer_id": { "type": "string" },
              "normalizer_version": { "type": "string" }
            },
            "required": ["scale_norm","conf","dir","normalizer_id","normalizer_version"],
            "additionalProperties": false
          }
        },
        "phl": { "$ref": "#/properties/payload_snapshot/properties/emo" }
      },
      "required": ["emo","phl"],
      "additionalProperties": false
    },
    "metrics": {
      "type": "object",
      "properties": {
        "S_emo": { "type": "number" },
        "S_phl": { "type": "number" },
        "theta_emo": { "type": "number" },
        "theta_phl": { "type": "number" },
        "rho": { "type": "number" }
      },
      "required": ["S_emo","S_phl","theta_emo","theta_phl","rho"],
      "additionalProperties": false
    },
    "provenance": {
      "type": "object",
      "properties": {
        "validator_name": { "type": "string" },
        "validator_version": { "type": "string" },
        "time_utc": { "type": "string", "format": "date-time" }
      },
      "required": ["validator_name","validator_version","time_utc"],
      "additionalProperties": false
    },
    "hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
  },
  "required": [
    "spec_version","commit_id","tick","diagram",
    "admission","payload_snapshot","metrics","provenance","hash"
  ],
  "additionalProperties": false
}
```

### ADS.5.1 Commit Hashing

* `hash = SHA-256(canonical-json(D \ {"hash"}))` with:

  * UTF-8, RFC-8785–style canonical JSON principles: sorted keys, no insignificant whitespace, canonical numbers (see ADS.6.3).

---

## ADS.6 Determinism & Numeric Policy

### ADS.6.1 Temporal Determinism

* Evaluation order is fixed: intra-row left→right, inter-column `E_SC → M_SC → P_SC`, phase barriers per timing rules.
* ABT executes **before** DEF in tick `T`; a commit (if any) advances `T` by 1.

### ADS.6.2 Structural Determinism

* Port presence is diagram-derived; **diagram supremacy** applies (T8.2).
* Admission sets are snapshots; no mutation after `A` is created.

### ADS.6.3 Numeric Determinism (interim)

* Number domain: IEEE-754 binary64.
* Serialization: decimal notation with minimal digits preserving round-trip to binary64; forbid `NaN`/`±∞` in commit objects.
* Comparisons: parity thresholds use exact binary64 operations; **no epsilon** unless future numeric model declares one.

---

## ADS.7 Safety, Liveness, and Idempotence

### ADS.7.1 Safety (must never happen)

* **Unvalidated payload at DEF**: prohibited by ADS.4.1(3); violations produce `E-DEF-702`.
* **Operators in DEF block**: `E-DEF-703`; DEF must not proceed.
* **Span leakage**: reaching DEF with any unclosed span → `E-DEF-701`.

### ADS.7.2 Liveness (progress)

* If ABT admits and closures are performed, a commit **must** be possible within the same tick barring DEF block violations.

### ADS.7.3 Idempotence

* Replaying the same `(A, Σ_structural)` yields identical `D.hash`; duplicate commits in the same tick are blocked (`E-DEF-704`).

---

## ADS.8 Error Mapping (ABT/DEF)

* **Ingress/Egress**: `E-ROUTE-401` (no open on ABT ingress), `E-ROUTE-402` (not closed before DEF).
* **Parity/Normalization**: `E-PARITY-501/502/503/504/505`, `E-NORM-A02/A03/A04/A05`.
* **Barriers**: `E-BARRIER-601/602`.
* **DEF**: `E-DEF-701/702/703/704`.
* **Precedence/Ports**: `E-PREC-802` (operator where no port exists).
* **Versioning**: `E-VERSION-901/902` if commit references incompatible spec/normalizers.

---

## ADS.9 Minimal Proof Obligations (informative but expected)

* **Soundness of commit**: If `Σ ⊢ ABT ⇓ A` and `Σ, A ⊢ DEF ⇓ D`, then:

  * all identifiers in `D.payload_snapshot` were present in `E*` at `A`,
  * both sides meet thresholds recorded in `D.metrics`,
  * every contributing span is closed at DEF.
* **Determinism**: For any two compliant implementations given identical `(diagram_digest, AST, S-MAP, normalizer catalog, thresholds)`, the produced `D.hash` is identical.
* **Non-interference of fences**: No operator effects after a **FIVE-V** fence may alter the admission set `E*` for the same ABT evaluation.

---

## ADS.10 Conformance Requirements

* Implementations **MUST**:

  * enforce ADS.3 and ADS.4 pre/post-conditions;
  * produce commit objects conforming to ADS.5;
  * reject non-finite numbers in payload snapshots and metrics;
  * treat any failure in ABT as a hard block to DEF in the same tick.
* Implementations **MUST NOT**:

  * mutate `A` after creation;
  * accept DEF with any operator token in its block;
  * aggregate multiple admissions into a single commit without passing through ABT and closures per tick.

---

## ADS.11 Extension Points (reserved)

* `commit_object.extensions`: future optional object for provenance signatures and privacy metadata (reserved; absent in 0.0.3).
* `admission.metadata.extensions`: future optional object for policy references (reserved).

---
