# CAH 0.0.4 — Core Spec Grammar

**Scope:** (1) Grammar, (3) Node I/O contracts, (5) Span object.

---

## 1) Grammar

### 1.1 Lexical tokens

* **Whitespace**

  * `SP` = space U+0020 (one or more where required).
  * `NL` = line break (`\n`).
  * `TAB` not permitted.
* **Box/Frame**

  * `CSP_BAR` = `│` (U+2502). Semantic column separator.
  * Box corners/edges (`┌ ┐ └ ┘ ├ ┤ ┬ ┴ ┼ ─`) are **non-semantic** and MAY appear only as framing; parsers MUST ignore them.
* **Punctuation**

  * `LP`=`(`, `RP`=`)`, `LB`=`[`, `RB`=`]`, `LCB`=`{`, `RCB`=`}`, `COL`=`:`, `BANG`=`!`, `LT`=`<`, `GT`=`>`, `V`=`v`, `PLUS`=`+`, `DASH`=`-`.
* **Keywords (fixed case)**

  * `CHO`, `ACT`, `DEC`, `ABT`, `DEF`, `emo`, `phl`.
* **Identifiers**

  * `EV_ID` = `ev` (`[a-z0-9_]*`) with at least one alphanumeric after `ev` (e.g., `evb`, `ev2`).
  * `PV_ID` = `pv` (`[a-z0-9_]*`) with at least one alphanumeric after `pv`.
  * Other bare identifiers are **reserved** and invalid in this version.

### 1.2 Operators (Flow Indicators, FID)

* **Atomic arrows**

  * `RIGHT` = `>`
  * `LEFT`  = `<`
* **Composites**

  * `OPEN_L`  = `<+`      (open into C-SP from left or open toward left context)
  * `OPEN_R`  = `+>`      (open into C-SP from right or open toward right context)
  * `CLOSE_L` = `-<`      (close toward left)
  * `CLOSE_R` = `>-`      (close toward right)
  * `BR_L`    = `<`       (neutral branch left)
  * `BR_R`    = `>`       (neutral branch right)
  * `DESC`    = `V` (rendered as `v`) (vertical descent marker)
* **Operator well-formedness**

  * `PLUS` MUST appear on the **open** side (`OPEN_L` or `OPEN_R`).
  * `DASH` MUST appear on the **closed** side (`CLOSE_L` or `CLOSE_R`).
  * `OPEN_*` MUST be paired by a subsequent `CLOSE_*` to form a span (see §5).

### 1.3 Structural terminals

* **Nodes**

  * `NODE_CHO` = `[` `CHO` `]`
  * `NODE_ACT` = `[` `ACT` `]`
  * `NODE_DEC` = `[` `DEC` `]`
  * `NODE_ABT` = `[` `LCB` `ABT` `RCB` `]`
  * `NODE_DEF` = `LT` `BANG` `DEF` `BANG` `GT`
* **Side band (lanes)**

  * `LANE` = `LP` `emo` `COL` `PAYLOAD_L` `COL` `phl` `RP`
  * `PAYLOAD_L` is defined by §1.4 (it contains side-typed variable sets).

### 1.4 Payloads (variables and sets)

* **Variable sets**

  * `EV_SET`  = `LCB` `EV_LIST` `RCB`
  * `PV_SET`  = `LCB` `PV_LIST` `RCB`
  * `EV_LIST` = `EV_ID` { `,` `SP`? `EV_ID` } | ε
  * `PV_LIST` = `PV_ID` { `,` `SP`? `PV_ID` } | ε
* **Band payload (ordered)**

  * `PAYLOAD_L` = `EV_SET` `,` `SP` `PV_SET`
    (The comma separates emotional and physical variable blocks when embedded in the center band.)

### 1.5 Columns and alignment (C-SP)

* **Columns**

  * `E_SC` (left/emo), `M_SC` (center/main), `P_SC` (right/phl).
* **Row form**

  * `ROW` = `SEG_E` `CSP_BAR` `SEG_M` `CSP_BAR` `SEG_P`
  * Each `SEG_*` is one of the segment types in §1.6.
  * Leading/trailing non-semantic box characters MAY enclose a row and MUST be ignored by parsers.

### 1.6 Segments

* **Node segment**

  * `SEG_NODE` = `NODE_CHO` | `NODE_ACT` | `NODE_DEC` | `NODE_ABT` | `NODE_DEF`
* **Flow segment**

  * `SEG_FLOW` = `FLOW_EXPR`
* **Lane segment**

  * `SEG_LANE` = `LANE`
* **Descent segment**

  * `SEG_DESC1` = `DESC`
  * `SEG_DESC3` = `DESC` `SP+` `DESC` `SP+` `DESC`      (Triple-V)
  * `SEG_DESCN` = `DESC`{`DESC`} with fixed counts where diagram prescribes (e.g., five `v` in mid-span)
* **Blank segment**

  * `SEG_BLANK` = ε
* **Allowed segment placements**

  * `LANE` segments MAY only appear in center rows prescribed by the diagram where side labeling occurs.
  * `NODE_DEF` MUST be placed in the main/center segment.

### 1.7 Flow expressions

* **Grammar**

  ```cah
  FLOW_EXPR      = TERM { SP? OP SP? TERM }
  OP             = OPEN_L | OPEN_R | CLOSE_L | CLOSE_R | BR_L | BR_R
  TERM           = DESC | SPAN_ANCHOR | VAR_REF | NODE_REF
  SPAN_ANCHOR    = ε          ; placeholder for span boundary positions in alignment with C-SP bars
  VAR_REF        = EV_ID | PV_ID
  NODE_REF       = NODE_ABT   ; only ABT may appear as an inline term in flows
  ```

* **Context-sensitivity**

  * Parsers MUST validate that `EV_ID` appears in `E_SC` or left-labeled contexts; `PV_ID` in `P_SC` or right-labeled contexts.
  * `OPEN_*`/`CLOSE_*` pairs MUST be well-nested across the **same row block group** (see §5).

### 1.8 Line ordering constraints

* A valid document SHALL contain rows that realize the following ordered node presence (not necessarily contiguous lines, framing rows permitted between):

  1. A `ROW` containing `NODE_CHO`.
  2. A subsequent `ROW` containing `NODE_ACT`.
  3. A subsequent `ROW` containing `NODE_DEC`.
  4. A subsequent block containing the left/right lane band and variable sets aligned with `E_SC`/`P_SC`.
  5. A subsequent `ROW` where `NODE_ABT` is addressable by flows.
  6. A terminal `ROW` containing `NODE_DEF`.

### 1.9 Well-formedness

* Parentheses, brackets, and braces MUST match and be properly ordered.
* `OPEN_*` MUST be eventually matched by `CLOSE_*` within the same **span group** (see §5).
* Triple-V and other fixed-count descent markers MUST match the diagram-specified counts where used.
* Only the keywords and identifiers defined in §1.1 are permitted.

## T9 — Whitespace & Layout Constraints

* Documents MUST be rendered in a monospace grid; `TAB` characters are prohibited.
* The triple-v sequence (`v     v     v`) uses exactly two spaces between each `v`.
* The five-v fence (`vvvvv`) is contiguous with no interstitial whitespace.
* Frame glyphs (`┌ ┐ └ ┘ ├ ┤ ┬ ┴ ┼ ─`) are non-semantic; parsers strip them before normalization and hashing.
* Any auxiliary line numbers or annotations are documentation-only and MUST NOT influence hashing or validation.

---

## 3) Node I/O Contracts

### 3.1 Common principles

* **Determinism:** For fixed inputs and flows, node outputs are deterministic.
* **Purity:** Nodes do not mutate prior committed state; all commits occur only at `DEF`.
* **Side-awareness:** Inputs may arrive via `E_SC`, `M_SC`, `P_SC`. Side semantics are normative.
* **Openness/Closure:** Nodes accept payloads crossing the C-SP only when spans are **open** upon entry and **closed** before handoff (see §5).

### 3.2 `CHO` (Choice)

* **Inputs**

  * None required; MAY receive context annotations in `M_SC` (non-committing).
* **Outputs**

  * Emits synchronized descent signals (`DESC`) onto `E_SC`, `M_SC`, `P_SC`.
* **Preconditions**

  * Document version and header (if present) are valid.
* **Postconditions**

  * Start-of-flow barrier established; downstream nodes MAY assume at least one descent signal per column.

### 3.3 `ACT` (Action)

* **Inputs**

  * Descent signals from `CHO` over all three columns.
* **Outputs**

  * Propagated descent; MAY attach provisional operational metadata on `M_SC`.
* **Preconditions**

  * Arrival of descent on `M_SC` is mandatory; side columns MAY be latent but cannot be contradictory (static checker MUST flag contradictions).
* **Postconditions**

  * Downstream segments MAY branch (`BR_*`) or open spans (`OPEN_*`) toward `DEC`.

### 3.4 `DEC` (Declare)

* **Inputs**

  * Descent/flows from `ACT`; optional open spans entering C-SP boundary.
* **Outputs**

  * Formalized intents/state descriptors attached to flows traversing toward the side band and `ABT`.
* **Preconditions**

  * All flows entering C-SP at this stage MUST be opened with `OPEN_*`.
* **Postconditions**

  * At least one valid route from `DEC` to the side band and to `ABT` is established.

### 3.5 `[{ABT}]` (Absolute gate)

* **Inputs**

  * Flows carrying side-keyed payloads (`EV_ID`, `PV_ID`) whose contributions have been routed from `DEC` under valid span openings.
* **Outputs**

  * Validated and normalized payloads eligible for commit; rejected payloads are emitted as errors (out-of-band per error model; outside this scope).
* **Preconditions**

  * All incoming flows must satisfy MD-flo parity: presence of **both** emotional and physical contributions aligned to their columns and balanced as per the parity checker (parity algorithm is outside the current scope; its interface is assumed).
  * Open spans that route into `ABT` MUST be **closed** (`CLOSE_*`) before egress toward `DEF`.
* **Postconditions**

  * All egressing payloads are side-correct, parity-validated, and span-closed.

### 3.6 `<!DEF!>` (Define, commit sink)

* **Inputs**

  * Only parity-validated, span-closed payloads from `ABT`.
* **Outputs**

  * A commit record (immutable) representing updated essentials/state. Serialization is canonical and version-pinned (format outside this scope; DEF emits a single logical commit unit per arrival tick).
* **Preconditions**

  * No open span may reach `DEF`. Any detection of an unclosed span is a hard error.
* **Postconditions**

  * Commit completed atomically; no further mutation occurs within the same evaluation tick.

---

## 5) Span Object (Open/Close Pairs)

### 5.1 Purpose

A **Span** encapsulates a directed traversal that **binds** payloads when crossing C-SP boundaries and ensures symmetrical closure before handoff to `ABT` and `DEF`.

### 5.2 Creation & identity

* **Creation**

  * A span is created when an `OPEN_*` operator is parsed in a `FLOW_EXPR`.
* **Identity**

  * Each span is assigned a monotonically increasing `span_id` scoped to the document.
  * `span_id` binds: opener location (row/column offset), side (`LEFT` or `RIGHT`), and originating column (`E_SC`, `M_SC`, or `P_SC`).

### 5.3 Shape & scope

* **Side**

  * `OPEN_L` / `CLOSE_L` define a **LEFT**-oriented span; `OPEN_R` / `CLOSE_R` define a **RIGHT**-oriented span.
* **Routing**

  * A span MAY traverse segments across rows provided it maintains continuity along permissible diagram paths (no illegal jumps). Parsers MUST validate row-to-row continuity relative to the C-SP.
* **Nesting**

  * Spans MAY nest. Nesting MUST be **well-nested** (stack discipline): the most recently opened span on a given side MUST be the first to close on that side.

### 5.4 Payload binding

* **Bindings**

  * A span acquires zero or more payload references (`EV_ID` on `E_SC`, `PV_ID` on `P_SC`) encountered along its route while the span is open.
* **Crossing C-SP**

  * A span crossing into the C-SP changes payload visibility from lane-local to center-scope. Only open spans can perform this binding.
* **Parity readiness**

  * Before reaching `ABT`, the aggregate payload set across all **concurrent** open spans must provide both emotional and physical contributions suitable for parity validation.

### 5.5 Closure rules

* **Required closure**

  * Every `OPEN_L` MUST be closed by a corresponding `CLOSE_L`; every `OPEN_R` by `CLOSE_R`.
* **Location**

  * Closure MUST occur no later than the final row that routes to `ABT` egress; spans MUST be closed **before** any flow segment that targets `DEF`.
* **Effects of closure**

  * On closure, the span’s payload binding freezes; no further identifiers may be attached.
* **Mismatches**

  * A close without a matching outstanding open, or an open that reaches `DEF` unclosed, is a structural error.

### 5.6 Concurrency & aggregation

* **Multiple spans**

  * Multiple spans may be open concurrently on each side. Their payloads are **unioned** for parity evaluation at `ABT`.
* **Order of evaluation**

  * Spans are evaluated in row order; within a row, left-to-right operator order is respected.
* **Barrier conditions**

  * A diagram-defined barrier (e.g., the “vvvvv” descent group) MAY act as a synchronization point. Spans opened before a barrier MUST either close before or explicitly traverse the barrier per routing rules.

### 5.7 Span state machine

* **States**

  * `NEW` → `OPEN` → `CLOSING` → `CLOSED`
* **Transitions**

  * `NEW` → `OPEN` on parsing `OPEN_*`.
  * `OPEN` → `CLOSING` upon first `CLOSE_*` token referencing the span’s side.
  * `CLOSING` → `CLOSED` after the close token is fully parsed and validated in context.
* **Invalid transitions**

  * Any additional `OPEN_*` for the same `span_id` is invalid.
  * Any attempt to attach payload after `CLOSING` is invalid.

### 5.8 Error conditions (span-specific)

* **E-SPAN-UNMATCHED-OPEN:** reached `DEF` with at least one unmatched `OPEN_*`.
* **E-SPAN-UNMATCHED-CLOSE:** encountered `CLOSE_*` without a corresponding prior `OPEN_*`.
* **E-SPAN-CROSS-ILLEGAL:** span route violates permissible C-SP crossings or column constraints.
* **E-SPAN-NESTING:** improper nesting order.
* **E-SPAN-PAYLOAD-SIDE:** `EV_ID` bound outside `E_SC` or `PV_ID` bound outside `P_SC`.

---
