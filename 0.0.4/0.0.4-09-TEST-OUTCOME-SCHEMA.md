# TOS — Test Outcome Schema (Validator Result Contract)

## TOS.1 Purpose

Machine-readable results for CI systems capturing per-test verdicts, diagnostics, metrics, and artifacts. Deterministic; compatible with CTM (conformance test manifest).

## TOS.2 Top-Level JSON Schema

```json
{
  "$id": "cah-0.0.4-test-outcome.schema.json",
  "title": "CAH Test Outcome",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "suite_id": { "type": "string", "pattern": "^[a-z0-9._-]{3,64}$" },
    "run_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{8,128}$" },
    "validator": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
        "commit": { "type": "string", "pattern": "^[a-f0-9]{7,40}$" }
      },
      "required": ["name","version"],
      "additionalProperties": false
    },
    "environment": {
      "type": "object",
      "properties": {
        "os": { "type": "string" },
        "arch": { "type": "string" },
        "cpu_count": { "type": "integer", "minimum": 1 },
        "memory_mb": { "type": "integer", "minimum": 1 },
        "runtime": { "type": "string" }
      },
      "additionalProperties": false
    },
    "start_time": { "type": "string", "format": "date-time" },
    "end_time": { "type": "string", "format": "date-time" },
    "summary": {
      "type": "object",
      "properties": {
        "total": { "type": "integer", "minimum": 0 },
        "passed": { "type": "integer", "minimum": 0 },
        "failed": { "type": "integer", "minimum": 0 },
        "warn_only": { "type": "integer", "minimum": 0 },
        "skipped": { "type": "integer", "minimum": 0 },
        "errors": { "type": "integer", "minimum": 0 },
        "warnings": { "type": "integer", "minimum": 0 },
        "duration_ms": { "type": "number", "minimum": 0.0 }
      },
      "required": ["total","passed","failed","duration_ms"],
      "additionalProperties": false
    },
    "results": {
      "type": "array",
      "items": { "$ref": "#/$defs/test_result" },
      "minItems": 1
    },
    "artifacts": {
      "type": "object",
      "properties": {
        "bundle_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "spec_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      },
      "additionalProperties": false
    }
  },
  "required": ["version","suite_id","run_id","validator","summary","results"],
  "additionalProperties": false,
  "$defs": {
    "test_result": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9._-]{3,64}$" },
        "title": { "type": "string" },
        "category": {
          "enum": [
            "LEX","PARSE","LAYOUT","PORTS","ROUTE","SPAN","SIDE",
            "BARRIER","NORM","PARITY","ABT","DEF","SERIALIZE","DIGEST","PREC","VERSION","PERF"
          ]
        },
        "intent": { "enum": ["POSITIVE","NEGATIVE","WARN_ONLY","PERF_BOUND"] },
        "status": { "enum": ["PASS","FAIL","WARN","SKIP","ERROR"] },
        "metrics": {
          "type": "object",
          "properties": {
            "duration_ms": { "type": "number", "minimum": 0.0 },
            "peak_memory_mb": { "type": "number", "minimum": 0.0 },
            "rows": { "type": "integer", "minimum": 0 },
            "spans": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "diagram_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "nodes_present": {
          "type": "array",
          "items": { "enum": ["CHO","ACT","DEC","ABT","DEF"] },
          "uniqueItems": true
        },
        "ports_present": {
          "type": "array",
          "items": { "enum": ["P_E1","P_P1","P_M1","P_A1"] },
          "uniqueItems": true
        },
        "diagnostics": {
          "type": "array",
          "items": { "$ref": "#/$defs/diagnostic" }
        },
        "validation_report": {
          "type": "object"
        }
      },
      "required": ["id","status"],
      "additionalProperties": false
    },
    "diagnostic": {
      "type": "object",
      "properties": {
        "code": { "type": "string", "pattern": "^E-[A-Z]+-[0-9A-Za-z]{3}$" },
        "severity": { "enum": ["ERROR","WARN"] },
        "message": { "type": "string" },
        "phase": { "pattern": "^P-[A-Z]+$" },
        "diagram_loc": {
          "type": "object",
          "properties": {
            "row": { "type": "integer", "minimum": 1 },
            "column": { "enum": ["E_SC","M_SC","P_SC"] },
            "offset": { "type": "integer", "minimum": 1 }
          },
          "required": ["row","column","offset"],
          "additionalProperties": false
        },
        "json_ptr": { "type": "string" }
      },
      "required": ["code","severity","message"],
      "additionalProperties": false
    }
  }
}
```

Dependency edges reference artifact identifiers via `from` and `to` path strings. Signatures are base64-encoded; when `scope` is `"file"` the `path` attribute identifies the signed entry.

## TOS.3 Semantics

- `status` mapping:

  - `PASS`: no ERRORs; intent satisfied.
  - `WARN`: no ERRORs; at least one WARN and intent permits warnings.
  - `FAIL`: expectations unsatisfied (including required digest/nodes/ports) or ERRORs present for non-negative intents.
  - `ERROR`: infrastructure or validator internal failure (no verdict possible).
  - `SKIP`: not executed by runner policy.
- `validation_report` may embed the full report (V1.5) for traceability or be omitted to keep artifacts slim.

## TOS.4 Aggregation Rules

- `summary.total` equals `results.length`.
- `summary.passed` counts `PASS` only.
- `summary.failed` counts `FAIL` + `ERROR`.
- `summary.warn_only` counts `WARN`.
- `summary.errors` / `summary.warnings` are totals over all diagnostics.

---

## RBM — Reference Bundle Manifest (Release Packaging Inventory)

## RBM.1 Purpose

Enumerate all normative files composing a CAH release, their roles, digests, and dependency relations for reproducible builds and verification.

## RBM.2 Top-Level JSON Schema

```json
{
  "$id": "cah-0.0.4-reference-bundle-manifest.schema.json",
  "title": "CAH Reference Bundle Manifest",
  "type": "object",
  "properties": {
    "spec_series": { "const": "CAH" },
    "bundle_version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
    "bundle_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "created": { "type": "string", "format": "date-time" },
    "publisher": { "type": "string" },
    "files": {
      "type": "array",
      "items": { "$ref": "#/$defs/file_entry" },
      "minItems": 1
    },
    "dependency_graph": {
      "type": "array",
      "items": { "$ref": "#/$defs/dep_edge" }
    },
    "signatures": {
      "type": "array",
      "items": { "$ref": "#/$defs/signature" }
    },
    "notes": { "type": "string" }
  },
  "required": ["spec_series","bundle_version","bundle_digest","files"],
  "additionalProperties": false,
  "$defs": {
    "file_entry": {
      "type": "object",
      "properties": {
        "path": { "type": "string" },
        "role": {
          "enum": [
            "schema","rules","registry","manifest","template",
            "legality_matrix","validator_contract","renderer_contract",
            "ast_spec","segment_map","canonical_algo","test_manifest_schema",
            "test_outcome_schema","changelog_schema","docs"
          ]
        },
        "format": { "enum": ["json","jsonschema","md","txt"] },
        "sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "size_bytes": { "type": "integer", "minimum": 0 },
        "version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
        "spec_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "optional": { "type": "boolean", "default": false }
      },
      "required": ["path","role","format","sha256","size_bytes","version"],
      "additionalProperties": false
    },
    "dep_edge": {
      "type": "object",
      "properties": {
        "from": { "type": "string" },
        "to": { "type": "string" },
        "kind": {
          "enum": [
            "references","imports","extends","validates","renders","consumes","produces"
          ]
        }
      },
      "required": ["from","to","kind"],
      "additionalProperties": false
    },
    "signature": {
      "type": "object",
      "properties": {
        "alg": { "enum": ["ed25519","ecdsa-p256","rsa-pss-sha256"] },
        "key_id": { "type": "string" },
        "sig": { "type": "string", "pattern": "^[A-Za-z0-9+/=]+$" },
        "scope": {
          "enum": ["bundle","file"]
        },
        "path": { "type": "string" }
      },
      "required": ["alg","key_id","sig","scope"],
      "additionalProperties": false
    }
  }
}
```

## RBM.3 Semantics

- `bundle_digest`: SHA-256 over a canonical concatenation of `files[*].sha256` in lexicographic `path` order separated by `\n`.
- `files[*].spec_digest`: optional cross-reference to the spec digest (T5.4) if the file embodies a spec slice.
- `dependency_graph`: acyclic; consumers verify absence of cycles for deterministic builds.
- `signatures`: optional; when present, CI SHOULD verify at least one `scope="bundle"` signature.

## RBM.4 Verification Procedure (Normative)

1. Verify each file’s SHA-256 against `files[*].sha256`.
2. Compute `bundle_digest` per RBM.3 and compare to manifest.
3. If signatures present: verify cryptographically; mismatch fails the bundle.
4. Optionally confirm each spec-bearing file’s `spec_digest` equals the digest derived from RCA where applicable.

---

## CI — Interchange & Exit Codes (Supplement)

## CI.1 Exit Codes

- `0`: All tests passed (no ERROR, no FAIL).
- `1`: At least one FAIL or ERROR.
- `2`: Invalid manifest/schema (CTM/TOS/RBM violation).
- `3`: Bundle verification failed (RBM signatures/digests).
- `4`: Environment mismatch (unsupported runtime/limits).

## CI.2 Minimal Fields Required for Ingestion

- From **CTM**: `suite_id`, `tests[*].id`, `tests[*].expect.passed`.
- From **TOS**: `suite_id`, `run_id`, `summary`, `results[*].id`, `results[*].status`.
- From **RBM**: `bundle_version`, `bundle_digest`, `files[*]`.

---
