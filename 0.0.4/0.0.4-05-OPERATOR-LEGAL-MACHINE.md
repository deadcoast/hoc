# (a) Machine-Readable Operator Legality Schema (by port / column)

**Format:** canonical JSON Schema–style (declarative), plus a compact machine table.
**Operators enum:** `"OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_L","BR_R","DESC"`
**Columns enum:** `"E_SC","M_SC","P_SC"`
**Ports enum:** `"P_E1","P_P1","P_M1","P_A1","NONE"`

* `P_E1`: left ingress/egress near C-SP (diagram row with `v<+` / `)>-`)
* `P_P1`: right ingress/egress near C-SP (diagram row with `+>v` / `-<(`)
* `P_M1`: center lateral redistribution (row with `> v <` inside M_SC)
* `P_A1`: ABT coupling inside M_SC (row with `+<[{ABT}]>+`)
* `NONE`: rows without an explicit port for that function

## A.1 JSON Schema (validator-facing)

```json
{
  "$id": "cah-0.0.4-operator-legality.schema.json",
  "title": "CAH Operator Legality Matrix",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "rules": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "column": { "enum": ["E_SC","M_SC","P_SC"] },
          "port": { "enum": ["P_E1","P_P1","P_M1","P_A1","NONE"] },
          "allowed": {
            "type": "array",
            "items": { "enum": ["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_L","BR_R","DESC"] },
            "uniqueItems": true
          },
          "forbidden": {
            "type": "array",
            "items": { "enum": ["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_L","BR_R","DESC"] },
            "uniqueItems": true
          },
          "constraints": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "code": { "type": "string" },
                "description": { "type": "string" },
                "when": { "type": "string" }
              },
              "required": ["code","description","when"],
              "additionalProperties": false
            }
          }
        },
        "required": ["column","port","allowed","forbidden"],
        "additionalProperties": false
      }
    }
  },
  "required": ["version","rules"],
  "additionalProperties": false
}
```

Each `constraints` entry pairs an error code, machine-readable description, and Boolean guard that determines when the constraint fires for a given operator instance.

## A.2 Canonical rule set (minimal, unambiguous)

```json
{
  "version": "0.0.4",
  "rules": [
    { "column":"E_SC","port":"P_E1","allowed":["OPEN_L","CLOSE_L","BR_L","DESC"],"forbidden":["OPEN_R","CLOSE_R","BR_R"] },
    { "column":"E_SC","port":"P_M1","allowed":["BR_L","DESC"],"forbidden":["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_R"] },
    { "column":"E_SC","port":"P_P1","allowed":["BR_L","DESC"],"forbidden":["OPEN_R","CLOSE_R","BR_R","OPEN_L","CLOSE_L"] },
    { "column":"E_SC","port":"P_A1","allowed":["BR_L","DESC"],"forbidden":["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_R"] },
    { "column":"E_SC","port":"NONE","allowed":["BR_L","DESC"],"forbidden":["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_R"] },

    { "column":"M_SC","port":"P_E1","allowed":["OPEN_L","CLOSE_L","BR_L","BR_R","DESC"],"forbidden":["OPEN_R","CLOSE_R"] ,
      "constraints":[
        { "code":"E-ROUTE-404","description":"No lateral redistribution without diagrammed port","when":"BR_L && !port_allows_lateral" }
      ]},
    { "column":"M_SC","port":"P_M1","allowed":["BR_L","BR_R","OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","DESC"],"forbidden":[] },
    { "column":"M_SC","port":"P_P1","allowed":["OPEN_R","CLOSE_R","BR_L","BR_R","DESC"],"forbidden":["OPEN_L","CLOSE_L"] },
    { "column":"M_SC","port":"P_A1","allowed":["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","DESC"],"forbidden":["BR_L","BR_R"],
      "constraints":[
        { "code":"E-ROUTE-401","description":"Ingress to ABT requires open span","when":"targets_ABT && !(OPEN_L||OPEN_R)" },
        { "code":"E-ROUTE-402","description":"Egress from ABT requires closure before DEF","when":"from_ABT && !(CLOSE_L||CLOSE_R)" }
      ]},
    { "column":"M_SC","port":"NONE","allowed":["DESC"],"forbidden":["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_L","BR_R"] },

    { "column":"P_SC","port":"P_P1","allowed":["OPEN_R","CLOSE_R","BR_R","DESC"],"forbidden":["OPEN_L","CLOSE_L","BR_L"] },
    { "column":"P_SC","port":"P_M1","allowed":["BR_R","DESC"],"forbidden":["OPEN_R","OPEN_L","CLOSE_R","CLOSE_L","BR_L"] },
    { "column":"P_SC","port":"P_E1","allowed":["BR_R","DESC"],"forbidden":["OPEN_L","CLOSE_L","BR_L","OPEN_R","CLOSE_R"] },
    { "column":"P_SC","port":"P_A1","allowed":["BR_R","DESC"],"forbidden":["OPEN_R","OPEN_L","CLOSE_R","CLOSE_L","BR_L"] },
    { "column":"P_SC","port":"NONE","allowed":["BR_R","DESC"],"forbidden":["OPEN_R","OPEN_L","CLOSE_R","CLOSE_L","BR_L"] }
  ]
}
```

`unit` indicates the expected measurement domain for resolved payloads (dimensionless allowed), while `params` stores the versioned coefficient set used by the normalizer implementation.

---

## (b) Normalizer Catalog Record Schema

**Purpose:** define registry entries for parity normalization (discoverable, versioned).

## B.1 JSON Schema

```json
{
  "$id": "cah-0.0.4-normalizer-catalog.schema.json",
  "title": "CAH Normalizer Catalog",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "catalog": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "normalizer_id": { "type": "string", "pattern": "^[a-z0-9._-]{3,64}$" },
          "domain": { "type": "string" },
          "unit": { "type": "string" },
          "policy": {
            "type": "object",
            "properties": {
              "direction": { "enum": ["HIGHER_IS_BETTER","LOWER_IS_BETTER","TARGET_IS_BEST"] },
              "bounds": {
                "type": "object",
                "properties": {
                  "min": { "type": "number" },
                  "max": { "type": "number" },
                  "target": { "type": "number" }
                },
                "additionalProperties": false
              },
              "clipping": { "enum": ["CLIP","SATURATE","REJECT"] }
            },
            "required": ["direction","clipping"],
            "additionalProperties": false
          },
          "params": { "type": "object", "additionalProperties": true },
          "normalizer_version": { "type": "string", "pattern": "^0\\.[0-9]+\\.[0-9]+$" },
          "bindings": {
            "type": "object",
            "properties": {
              "emo": { "type": "array", "items": { "type": "string", "pattern": "^ev[a-z0-9_]+$" }, "uniqueItems": true },
              "phl": { "type": "array", "items": { "type": "string", "pattern": "^pv[a-z0-9_]+$" }, "uniqueItems": true }
            },
            "additionalProperties": false
          },
          "enabled": { "type": "boolean" }
        },
        "required": ["normalizer_id","domain","unit","policy","params","normalizer_version","bindings","enabled"],
        "additionalProperties": false
      }
    },
    "thresholds": {
      "type": "object",
      "properties": {
        "theta_emo": { "type": "number", "minimum": 0 },
        "theta_phl": { "type": "number", "minimum": 0 },
        "balance_ratio": { "type": "number", "exclusiveMinimum": 0, "maximum": 1 }
      },
      "required": ["theta_emo","theta_phl","balance_ratio"],
      "additionalProperties": false
    }
  },
  "required": ["version","catalog","thresholds"],
  "additionalProperties": false
}
```

## B.2 Registry invariants

* Each `ev*`/`pv*` identifier MUST appear in **at most one** `bindings` list across the catalog. Violation ⇒ `E-NORM-A01`.
* `unit` MUST match the unit declared at payload supply; mismatch ⇒ `E-NORM-A03`.
* `normalizer_version.major` MUST be `0` under spec `0.0.4`. Otherwise ⇒ `E-VERSION-902`.
* Disabled entries (`enabled=false`) MUST be ignored at resolution; unresolved mapping ⇒ `E-PARITY-504`.

---

## (c) Error Message Dictionary (canonical text)

**Format:** `code: "message"`
Messages are concise, imperative, and machine-displayable.

### Syntax — `E-SYN-*`

* `E-SYN-101`: "Unknown token."
* `E-SYN-102`: "Unbalanced brackets, parentheses, or braces."
* `E-SYN-103`: "TAB characters are forbidden."
* `E-SYN-104`: "Illegal keyword; not in notation registry."
* `E-SYN-105`: "Illegal operator composition."

### Layout — `E-LYT-*`

* `E-LYT-201`: "Token crosses a column border (│)."
* `E-LYT-202`: "Lateral redistribution requires a diagrammed port."
* `E-LYT-203`: "Frame glyphs must not appear inside semantic segments."

### Span — `E-SPAN-*`

* `E-SPAN-301`: "Unmatched span opener."
* `E-SPAN-302`: "Unmatched span closer."
* `E-SPAN-303`: "Improper span nesting (stack violation)."
* `E-SPAN-304`: "Empty span is not allowed."
* `E-SPAN-305`: "Payload attachment after span closure."
* `E-SPAN-306`: "Illegal span crossing for this column or port."
* `E-SPAN-307`: "Variable bound on the wrong side (ev*/pv* side error)."

### Routing — `E-ROUTE-*`

* `E-ROUTE-401`: "Crossing the C-SP requires an open span."
* `E-ROUTE-402`: "Egress from the C-SP requires span closure."
* `E-ROUTE-403`: "Branch operator chain must contain a term between branches."
* `E-ROUTE-404`: "Illegal horizontal branch; no port available in this row."

### Parity — `E-PARITY-*`

* `E-PARITY-501`: "Parity failed: missing side (no `ev*` or no `pv*`)."
* `E-PARITY-502`: "Parity failed: side threshold not met."
* `E-PARITY-503`: "Parity failed: balance ratio below required minimum."
* `E-PARITY-504`: "Parity failed: normalizer unresolved for one or more variables."
* `E-PARITY-505`: "Parity failed: input rejected by normalizer policy."

### Barrier — `E-BARRIER-*`

* `E-BARRIER-601`: "Operator cannot cross a descent fence."
* `E-BARRIER-602`: "Span state mutated across a barrier without traversal permission."

### Commit/DEF — `E-DEF-*`

* `E-DEF-701`: "Unclosed span reached DEF."
* `E-DEF-702`: "Non-validated payload presented to DEF."
* `E-DEF-703`: "Operators are forbidden in the DEF block."
* `E-DEF-704`: "Multiple commits in a single evaluation tick are not allowed."

### Precedence/Diagram — `E-PREC-*`

* `E-PREC-801`: "Diagram supremacy applied: text/structure divergence detected."
* `E-PREC-802`: "Operator used where the diagram provides no structural port."

### Versioning/Compatibility — `E-VERSION-*`

* `E-VERSION-901`: "Spec version missing or incompatible with 0.0.4."
* `E-VERSION-902`: "Normalizer version incompatible with spec version."

### Normalization — `E-NORM-*`

* `E-NORM-A01`: "Normalizer registration conflict or duplicate binding."
* `E-NORM-A02`: "Failed to resolve normalizer for variable."
* `E-NORM-A03`: "Unit mismatch for normalizer."
* `E-NORM-A04`: "Input value out of policy bounds."
* `E-NORM-A05`: "Non-monotonic mapping detected for normalizer."

---
