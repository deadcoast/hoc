# A-ST — Abstract Syntax Tree (Opaque but Normative Shape)

## A-ST.1 Node kinds (enum)

`"DOCUMENT","ROW","SEGMENT","TOKEN","FLOW_EXPR","OP","TERM","NODE","LANE","VAR_SET","PORT","DESC_FENCE"`

## A-ST.2 Common fields

All AST nodes share:

- `kind`: one of A-ST.1
- `id`: stable string (implementer-defined; unique within tree)
- `span`: `{row:int, column:"E_SC|M_SC|P_SC|FRAME", start:int, end:int}` — diagram source coordinates
- `children`: array of node `id`s (tree edges; empty when leaf)

## A-ST.3 Root

```json
{
  "kind":"DOCUMENT",
  "version":"0.0.4",
  "digest":"<hex>",
  "rows":[ "ROW-…" ],
  "ports":[ "PORT-…" ],
  "nodes":[ "NODE-…" ],
  "desc_fences":[ "DESC-…" ],
  "index": {
    "byRow": { "1":[ "SEG-…" ], "2":[ "SEG-…" ] },
    "byNodeKind": { "CHO":[ "NODE-…" ], "ACT":[…], "DEC":[…], "ABT":[…], "DEF":[…] },
    "byVar": { "ev…":[ "TOKEN-…" ], "pv…":[ "TOKEN-…" ] },
    "bySpanGroup": { "G1":[ "OP-OPEN","OP-CLOSE",… ] }
  }
}
```

*`flow`* holds zero or one `FLOW_EXPR` references per segment;

- additional flows appear as siblings in the array
- *`lanes`* populate only the center band rows that carry `(emo: … :phl)`
- *`nodes`* lists any diagram nodes located inside the segment.

## A-ST.4 ROW

```json
{
  "kind":"ROW",
  "row":1,
  "segments":[ "SEG-E","SEG-M","SEG-P" ],
  "ports":[ "PORT-…","…" ],
  "desc_fences":[ "DESC-…" ]
}
```

The `order` array captures the precise operator/term evaluation order inside the segment, and `span_group` links paired open/close operations for stack validation.

## A-ST.5 SEGMENT

```json
{
  "kind":"SEGMENT",
  "column":"E_SC|M_SC|P_SC",
  "tokens":[ "TOKEN-…" ],
  "flow":[ "FLOW-…" ],
  "lanes":[ "LANE-…" ],
  "nodes":[ "NODE-…" ]
}
```

`glyphs` records the slice of diagram text associated with the detected port to aid audits of the parsed structure.

## A-ST.6 TOKEN

```json
{
  "kind":"TOKEN",
  "tokenType":"KW|OP|DELIM|IDENT|BORDER|SPACE",
  "value":"raw-lexeme",
  "norm":"normalized-lexeme",
  "attrs":{ "side":"LEFT|RIGHT|null" }
}
```

## A-ST.7 FLOW_EXPR

```json
{
  "kind":"FLOW_EXPR",
  "ops":[ "OP-…" ],
  "terms":[ "TERM-…" ],
  "order":[ "OP-…","TERM-…","…" ],
  "span_group":"G1"
}
```

## A-ST.8 OP

```json
{
  "kind":"OP",
  "opType":"OPEN_L|OPEN_R|CLOSE_L|CLOSE_R|BR_L|BR_R|DESC",
  "side":"LEFT|RIGHT|null",
  "portContext":"P_E1|P_P1|P_M1|P_A1|NONE"
}
```

## A-ST.9 TERM

```json
{
  "kind":"TERM",
  "termType":"VAR|NODE_ABT|SPAN_ANCHOR",
  "ref":"ev…|pv…|NODE-ABT|null"
}
```

## A-ST.10 NODE (diagram nodes)

```json
{
  "kind":"NODE",
  "nodeType":"CHO|ACT|DEC|ABT|DEF",
  "column":"E_SC|M_SC|P_SC",
  "row":1
}
```

## A-ST.11 LANE (center band)

```json
{
  "kind":"LANE",
  "leftLabel":"emo",
  "rightLabel":"phl",
  "varSets":[ "VARSET-EMO","VARSET-PHL" ]
}
```

## A-ST.12 VAR_SET

```json
{
  "kind":"VAR_SET",
  "side":"EMO|PHL",
  "idents":[ "ev…|pv…" ],
  "sourceTokens":[ "TOKEN-IDENT-…" ]
}
```

## A-ST.13 PORT

```json
{
  "kind":"PORT",
  "portType":"P_E1|P_P1|P_M1|P_A1",
  "row":1,
  "column":"E_SC|M_SC|P_SC|ROW_SCOPE",
  "glyphs":"raw-slice"
}
```

## A-ST.14 DESC_FENCE

```json
{
  "kind":"DESC_FENCE",
  "fenceType":"TRIPLE|FIVE",
  "row":1,
  "column":"E_SC|M_SC|P_SC|ROW_SCOPE"
}
```

---

## S-MAP — Segment Map Schema (Grid-Oriented)

## S-MAP.1 Overview

A dense matrix representing each row’s three semantic segments with normalized token streams, port flags, descent fences, and quick-lookup indices for validators.

## S-MAP.2 Schema

```json
{
  "$id": "cah-0.0.4-segment-map.schema.json",
  "title": "CAH Segment Map",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "rows": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "row": { "type": "integer", "minimum": 1 },
          "segments": {
            "type": "object",
            "properties": {
              "E_SC": { "$ref": "#/$defs/segment" },
              "M_SC": { "$ref": "#/$defs/segment" },
              "P_SC": { "$ref": "#/$defs/segment" }
            },
            "required": ["E_SC","M_SC","P_SC"],
            "additionalProperties": false
          },
          "ports": {
            "type": "array",
            "items": { "$ref": "#/$defs/port" },
            "uniqueItems": true
          },
          "fences": {
            "type": "array",
            "items": { "$ref": "#/$defs/fence" }
          }
        },
        "required": ["row","segments","ports","fences"],
        "additionalProperties": false
      }
    },
    "indices": {
      "type": "object",
      "properties": {
        "nodesByType": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "$ref": "#/$defs/coord" }
          }
        },
        "varsBySide": {
          "type": "object",
          "properties": {
            "emo": { "type": "array", "items": { "$ref": "#/$defs/varRef" } },
            "phl": { "type": "array", "items": { "$ref": "#/$defs/varRef" } }
          },
          "required": ["emo","phl"],
          "additionalProperties": false
        },
        "spansByGroup": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "$ref": "#/$defs/spanRef" }
          }
        }
      },
      "required": ["nodesByType","varsBySide","spansByGroup"],
      "additionalProperties": false
    }
  },
  "required": ["version","rows","indices"],
  "$defs": {
    "segment": {
      "type": "object",
      "properties": {
        "column": { "enum": ["E_SC","M_SC","P_SC"] },
        "tokens": {
          "type": "array",
          "items": { "$ref": "#/$defs/token" }
        },
        "flows": {
          "type": "array",
          "items": { "$ref": "#/$defs/flow" }
        },
        "lanes": {
          "type": "array",
          "items": { "$ref": "#/$defs/lane" }
        },
        "nodes": {
          "type": "array",
          "items": { "$ref": "#/$defs/node" }
        }
      },
      "required": ["column","tokens","flows","nodes","lanes"],
      "additionalProperties": false
    },
    "token": {
      "type": "object",
      "properties": {
        "type": { "enum": ["KW","OP","DELIM","IDENT","BORDER","SPACE"] },
        "value": { "type": "string" },
        "norm": { "type": "string" },
        "offset": { "type": "integer", "minimum": 1 }
      },
      "required": ["type","value","norm","offset"],
      "additionalProperties": false
    },
    "flow": {
      "type": "object",
      "properties": {
        "span_group": { "type": "string" },
        "ops": { "type": "array", "items": { "$ref": "#/$defs/op" } },
        "terms": { "type": "array", "items": { "$ref": "#/$defs/term" } },
        "order": { "type": "array", "items": { "type": "string" } }
      },
      "required": ["span_group","ops","terms","order"],
      "additionalProperties": false
    },
    "op": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "opType": { "enum": ["OPEN_L","OPEN_R","CLOSE_L","CLOSE_R","BR_L","BR_R","DESC"] },
        "side": { "enum": ["LEFT","RIGHT",null] },
        "portContext": { "enum": ["P_E1","P_P1","P_M1","P_A1","NONE"] },
        "offset": { "type": "integer", "minimum": 1 }
      },
      "required": ["id","opType","portContext","offset"],
      "additionalProperties": false
    },
    "term": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "termType": { "enum": ["VAR","NODE_ABT","SPAN_ANCHOR"] },
        "ref": { "type": ["string","null"] },
        "offset": { "type": "integer", "minimum": 1 }
      },
      "required": ["id","termType","offset"],
      "additionalProperties": false
    },
    "lane": {
      "type": "object",
      "properties": {
        "leftLabel": { "const": "emo" },
        "rightLabel": { "const": "phl" },
        "emoVars": { "type": "array", "items": { "type": "string", "pattern": "^ev[a-z0-9_]+$" } },
        "phlVars": { "type": "array", "items": { "type": "string", "pattern": "^pv[a-z0-9_]+$" } }
      },
      "required": ["leftLabel","rightLabel","emoVars","phlVars"],
      "additionalProperties": false
    },
    "node": {
      "type": "object",
      "properties": {
        "nodeType": { "enum": ["CHO","ACT","DEC","ABT","DEF"] },
        "offset": { "type": "integer", "minimum": 1 }
      },
      "required": ["nodeType","offset"],
      "additionalProperties": false
    },
    "port": {
      "type": "object",
      "properties": {
        "portType": { "enum": ["P_E1","P_P1","P_M1","P_A1"] },
        "row": { "type": "integer", "minimum": 1 },
        "column": { "enum": ["E_SC","M_SC","P_SC","ROW_SCOPE"] }
      },
      "required": ["portType","row","column"],
      "additionalProperties": false
    },
    "fence": {
      "type": "object",
      "properties": {
        "fenceType": { "enum": ["TRIPLE","FIVE"] },
        "row": { "type": "integer", "minimum": 1 },
        "column": { "enum": ["E_SC","M_SC","P_SC","ROW_SCOPE"] }
      },
      "required": ["fenceType","row","column"],
      "additionalProperties": false
    },
    "coord": {
      "type": "object",
      "properties": {
        "row": { "type": "integer", "minimum": 1 },
        "column": { "enum": ["E_SC","M_SC","P_SC"] },
        "offset": { "type": "integer", "minimum": 1 }
      },
      "required": ["row","column","offset"],
      "additionalProperties": false
    },
    "varRef": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "row": { "type": "integer", "minimum": 1 },
        "column": { "enum": ["E_SC","P_SC"] },
        "offset": { "type": "integer", "minimum": 1 }
      },
      "required": ["id","row","column","offset"],
      "additionalProperties": false
    },
    "spanRef": {
      "type": "object",
      "properties": {
        "span_group": { "type": "string" },
        "row": { "type": "integer", "minimum": 1 },
        "column": { "enum": ["E_SC","M_SC","P_SC"] },
        "opRef": { "type": "string" }
      },
      "required": ["span_group","row","column","opRef"],
      "additionalProperties": false
    }
  }
}
```

---

## RND — Renderer Contract (Diagram ⇄ Structure)

## RND.1 Responsibilities

- **Render**: structure → ASCII diagram (canonical glyph stream).
- **Parse**: ASCII diagram → AST + Segment Map.
- **Normalize**: apply T5.3 rules identically in both directions.

## RND.2 Render invariants

- Exactly one `│` per segment boundary.
- Triple-v spacing and five-v fence must be faithful.
- Frame glyphs are optional; if rendered, must not interleave semantic tokens.

## RND.3 Round-trip guarantee

- `digest(render(parse(diagram))) == digest(diagram)`
- `digest(render(structure)) == diagram_digest(structure)`

---

## IDX — Implementation Indices (Mandatory)

## IDX.1 Fast lookups

- `var → [coords]` (side-aware)
- `span_group → [op ids]` (stack checks)
- `row → port set`
- `nodeType → coords`
- `fenceType → rows`

## IDX.2 Cache policy

- Recompute on parse; immutable thereafter within a validation run.

---

## FSM — Parser State Machines (High-Level)

## FSM.1 Flow expression DFA (per segment)

States: `S0`(start) → `OPEN|BR|TERM|CLOSE|DESC` with transitions:

- `S0 → OPEN|BR|TERM|DESC`
- `OPEN → TERM`
- `TERM → CLOSE|BR|TERM` (term adjacency allowed by grammar order)
- `BR → TERM`
- `CLOSE → CLOSE|BR|TERM|DESC`
- `DESC` is an accepting fence; no transitions across in same eval step
  Rejecting transitions yield `E-SYN-105` or `E-ROUTE-403`.

## FSM.2 Span stack discipline (per side)

- On `OPEN_L|OPEN_R`: push span_group id.
- On `CLOSE_L|CLOSE_R`: pop; mismatch → `E-SPAN-303/302`.

---

## IMP — Conformance Requirements

## IMP.1 MUST

- Enforce all schemas herein.
- Emit dual-tag diagnostics where applicable.
- Respect evaluation phases and stop-on-error policy per phase.

## IMP.2 MUST NOT

- Infer ports beyond the diagrammed port classes.
- Reorder operators across descent fences.
- Accept variables with non-`ev*`/`pv*` prefixes.

## IMP.3 SHOULD

- Provide stable `id` generation for AST nodes (row/column/offset based).
- Provide pretty-printers for diagnostics with row/column indicators.

---
