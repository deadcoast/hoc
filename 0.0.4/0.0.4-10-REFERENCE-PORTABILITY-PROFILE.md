# RPP — Reference Portability Profile (Permissible Deviations Between Implementations)

## RPP.1 Purpose

Enumerate narrowly scoped, explicitly permitted deviations that do not alter semantic outcomes or `diagram_digest`, enabling interoperable validators/renderers across environments.

## RPP.2 Principles

* Deviations MUST NOT change: span pairing, routing legality, parity decisions, ABT/DEF contracts, or canonical serialization order.
* Deviations MAY affect: internal data structures, non-semantic whitespace handling **before** canonicalization, diagnostic formatting (not codes), and performance envelopes.
* All deviations MUST be declared via a **Portability Profile** document conforming to this schema.

## RPP.3 JSON Schema

```json
{
  "$id": "cah-0.0.4-portability-profile.schema.json",
  "title": "CAH Reference Portability Profile",
  "type": "object",
  "properties": {
    "version": { "const": "0.0.4" },
    "impl_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{3,64}$" },
    "impl_version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
    "capabilities": {
      "type": "object",
      "properties": {
        "max_rows": { "type": "integer", "minimum": 10000 },
        "max_spans": { "type": "integer", "minimum": 1000 },
        "unicode_normalization": { "enum": ["NFC"] },
        "hash_algorithm": { "const": "SHA-256" }
      },
      "required": ["unicode_normalization","hash_algorithm"],
      "additionalProperties": false
    },
    "deviations": {
      "type": "array",
      "items": { "$ref": "#/$defs/deviation" }
    },
    "diagnostics_policy": {
      "type": "object",
      "properties": {
        "message_style": { "enum": ["concise","extended"] },
        "stack_traces": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "performance_targets": {
      "type": "object",
      "properties": {
        "rows_per_second": { "type": "number", "minimum": 0 },
        "memory_mb_peak": { "type": "number", "minimum": 0 }
      },
      "additionalProperties": false
    },
    "non_semantic_equivalences": {
      "type": "array",
      "items": { "$ref": "#/$defs/equiv" }
    },
    "conformance_level": { "enum": ["LEVEL_A","LEVEL_B","LEVEL_C"] }
  },
  "required": ["version","impl_id","impl_version","conformance_level"],
  "additionalProperties": false,
  "$defs": {
    "deviation": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9._-]{3,64}$" },
        "area": {
          "enum": [
            "LEX","LAYOUT","PORTS","ROUTE","SPAN","SIDE","BARRIER",
            "NORM","PARITY","ABT","DEF","SERIALIZE","DIGEST","PREC","VERSION","PERF","DIAGNOSTICS"
          ]
        },
        "kind": { "enum": ["IMPLEMENTATION_DETAIL","NON_SEMANTIC","TEMPORARY_LIMITATION"] },
        "description": { "type": "string" },
        "constraints": { "type": "string" },  // machine-readable note or policy reference
        "expires_on": { "type": "string", "format": "date" },
        "severity": { "enum": ["LOW","MEDIUM","HIGH"] },
        "justification": { "type": "string" }
      },
      "required": ["id","area","kind","description","severity"],
      "additionalProperties": false
    },
    "equiv": {
      "type": "object",
      "properties": {
        "topic": { "enum": ["diagnostic_message_text","warning_order","artifact_elision"] },
        "policy": { "type": "string" }  // e.g., "free-order-warns", "elide-ast"
      },
      "required": ["topic","policy"],
      "additionalProperties": false
    }
  }
}
```

## RPP.4 Conformance Levels (mapped to MCC)

* **LEVEL_A (Authoring)**: Meets **MCC.1–MCC.5** and **MCC.10**. Partial validation, no mandatory serialization output.
* **LEVEL_B (Integration)**: Meets **MCC.1–MCC.9** and **MCC.11**. Full validation through DEF; JSON required.
* **LEVEL_C (Commit)**: Meets **all MCC** items including **MCC.12**; RCA round-trip and digest asserted.

## RPP.5 Validation of RPP

* Any deviation in areas `ROUTE`, `SPAN`, `PARITY`, `ABT`, `DEF`, `SERIALIZE`, or `DIGEST` MUST be `kind="TEMPORARY_LIMITATION"` with `expires_on`.
* Deviations marked `HIGH` severity MUST include a `justification` and MAY block **LEVEL_C** certification.

---

## CBS — Compliance Badge Spec (Levels, Metadata, Display Rules)

## CBS.1 Purpose

Standardize issuance, display, and verification of CAH conformance badges for implementations and artifacts.

## CBS.2 Badge Levels

* `CAH-0.0.4-A` — Authoring compliance (RPP LEVEL_A).
* `CAH-0.0.4-B` — Integration compliance (RPP LEVEL_B).
* `CAH-0.0.4-C` — Commit compliance (RPP LEVEL_C).

## CBS.3 Badge Artifact (JSON, verifiable)

```json
{
  "$id": "cah-0.0.4-compliance-badge.schema.json",
  "title": "CAH Compliance Badge",
  "type": "object",
  "properties": {
    "series": { "const": "CAH" },
    "level": { "enum": ["CAH-0.0.4-A","CAH-0.0.4-B","CAH-0.0.4-C"] },
    "issuer": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{3,64}$" },
        "pubkey": { "type": "string" }  // PEM or JWK thumbprint
      },
      "required": ["name","id"]
    },
    "subject": {
      "type": "object",
      "properties": {
        "impl_id": { "type": "string", "pattern": "^[A-Za-z0-9._-]{3,64}$" },
        "impl_version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
        "artifact_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      },
      "required": ["impl_id","impl_version"]
    },
    "rpp": { "$ref": "cah-0.0.4-portability-profile.schema.json#" },
    "evidence": {
      "type": "object",
      "properties": {
        "ctm_suite_id": { "type": "string" },
        "tos_run_id": { "type": "string" },
        "tos_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "rbm_bundle_digest": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      },
      "additionalProperties": false
    },
    "issued_at": { "type": "string", "format": "date-time" },
    "expires_at": { "type": "string", "format": "date-time" },
    "signature": {
      "type": "object",
      "properties": {
        "alg": { "enum": ["ed25519","ecdsa-p256","rsa-pss-sha256"] },
        "key_id": { "type": "string" },
        "sig": { "type": "string", "pattern": "^[A-Za-z0-9+/=]+$" }  // base64
      },
      "required": ["alg","key_id","sig"],
      "additionalProperties": false
    },
    "revocation": {
      "type": "object",
      "properties": {
        "status": { "enum": ["valid","revoked","suspended"] },
        "reason": { "type": "string" },
        "updated": { "type": "string", "format": "date-time" }
      },
      "additionalProperties": false
    }
  },
  "required": ["series","level","issuer","subject","issued_at"],
  "additionalProperties": false
}
```

## CBS.4 SVG/Visual Badge (metadata header)

* Implementations MAY embed the JSON badge as an `application/json` metadata block inside SVG for display.
* Visual elements (colors, icons) are non-normative; the **embedded JSON** is authoritative.

## CBS.5 Issuance Criteria (Normative)

* **Level A**: Must supply `RPP.conformance_level==LEVEL_A`, pass CTM tests categorized up to `DEF` **excluding** parity thresholds override, and produce a valid **TOS** with `summary.failed==0`.
* **Level B**: `RPP.conformance_level==LEVEL_B`, pass all CTM tests through `DEF`, include serialization/digest tests, `summary.failed==0`, `summary.errors==0`.
* **Level C**: `RPP.conformance_level==LEVEL_C`, pass **all** CTM tests including PREC/VERSION, and round-trip RCA checks; `summary.failed==0`, `summary.errors==0`, and any `deviations` with `area ∈ {"ROUTE","SPAN","PARITY","ABT","DEF","SERIALIZE","DIGEST"}` MUST be absent.

## CBS.6 Verification Procedure

1. Validate badge JSON against CBS schema.
2. Verify signature using `issuer.pubkey` or registry.
3. Fetch **TOS** (or provided digest) and **RBM** bundle digest; ensure they match `evidence`.
4. Validate `rpp` against RPP schema; ensure `conformance_level` is consistent with `level`.
5. Check `expires_at` (if present) and `revocation.status != "revoked"`.

## CBS.7 Revocation & Suspension

* Issuer MAY set `revocation.status` to `"revoked"` or `"suspended"` with `reason` and `updated`.
* Verifiers MUST treat `"revoked"` as invalid; `"suspended"` is implementation policy but SHOULD fail **Level C** gating.

## CBS.8 Display Rules

* Badge display MUST include **series** and **level** text.
* If the JSON badge is embedded in SVG, any representation must not contradict JSON.
* Caching of badge artifacts SHOULD respect `expires_at`.

---
